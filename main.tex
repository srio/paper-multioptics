%RC24/02/2022 - TODO: change all "X-ray" to "x-ray"

%\documentclass[preprint]{iucr}              % DO NOT DELETE THIS LINE
\documentclass{iucr}              % DO NOT DELETE THIS LINE

\usepackage{siunitx}
\usepackage{color}
% \usepackage{amsmath,amssymb}
\usepackage{amsfonts} 
\usepackage{mathtools}
\usepackage[normalem]{ulem}
% rotation table labels...
% see https://tex.stackexchange.com/questions/98388/how-to-make-table-with-rotated-table-headers-in-latex
\usepackage{adjustbox}
\usepackage{array}
\usepackage{booktabs}
\usepackage{multirow}
\usepackage{enumitem}

\newcommand{\todo}[1]{{\color{red}[TODO: "#1'']}}
\newcommand{\inblue}[1]{{\color{blue}#1}}
\newcommand{\inred}[1]{{\color{red}#1}}
\newcommand{\ingreen}[1]{{\color{green}#1}}
\newcommand{\soutred}[1]{{\color{red}\sout{#1}}}
\newcommand{\lambdabar}{{\mkern0.75mu\mathchar '26\mkern -8.2mu\lambda}}

\definecolor{JSR_blue}{RGB}{51, 102, 154}
\newcommand{\jsrblue}[1]{\textcolor{JSR_blue}{#1}}

\newcolumntype{R}[2]{%
    >{\adjustbox{angle=#1,lap=\width-(#2)}\bgroup}%
    l%
    <{\egroup}%
}
\newcommand*\rot{\multicolumn{1}{R{90}{1em}}
%
}
\journalcode{S}


\begin{document}                  % DO NOT DELETE THIS LINE

% \title{Focusing partially-coherent x-ray beams with lenses. Multi-optics simulations}
\title{A fast and light tool-set for partially-coherent beamline simulations in 4$^{\text{th}}$ generation storage rings based on coherent mode decomposition}

\cauthor[]{\jsrblue{Manuel}}{\jsrblue{Sanchez del Rio}}{srio@esrf.eu}{address if different from \aff}
\author[]{\jsrblue{Rafael}}{\jsrblue{Celestre}}
\author[]{\jsrblue{Juan}}{\jsrblue{Reyes-Herrera}}
\author[]{\newline \jsrblue{Philipp}}{\jsrblue{Brumund}}
\author[]{\jsrblue{Marco}}{\jsrblue{Cammarata}}

\aff[]{ESRF - The European Synchrotron, 71 Avenue des Martyrs, 38000 Grenoble, \country{France}}

\maketitle                        % DO NOT DELETE THIS LINE

% -----------------------------------------------------------------
% -----------------------------------------------------------------

\begin{synopsis}
Simulations of focusing partial coherent beams with x-ray lenses are performed with different software packages (ShadowOui, SRW, COMSYYL and WOFRY). The four codes give comparable results, that are discussed in detail. 
\end{synopsis}

% -----------------------------------------------------------------
% -----------------------------------------------------------------

\begin{abstract}
We simulate the focusing of the radiation produced by fourth-generation storage rings and present a new algorithm to perform coherent mode decomposition (CMD) of the undulator radiation requiring low computer resources, like a common laptop. It is based in reducing the problem to treating one-dimension wavefront cuts \inred{and recombining them to produce a 2D wavefront}. The validity of this approximation is discussed. Benchmarking shows that its results compared well against multiple optics packages implementing a variety of methods for dealing with partial coherence: full 2D coherent mode decomposition, Monte-Carlo combination of wavefronts from electrons entering the undulator with different initial conditions, and hybrid ray-tracing correcting geometrical optics with wave optics. %The new code gives comparable results to the other codes for an undulator and four different setups of an optical system composed by a slit and two transfocators.
\end{abstract}

% -----------------------------------------------------------------
% -----------------------------------------------------------------
\section{Introduction}
\label{sec:introduction}
% -----------------------------------------------------------------
% -----------------------------------------------------------------

The migration to fourth-generation storage-rings has significantly improved brilliance and coherence of the X-ray synchrotron sources. The transverse coherent fraction of the new sources is increased by at least one order of magnitude with respect the 3$^{\text{rd}}$ generation sources (typically from 10$^{-3}$ to 10$^{-2}$ at 10 keV). This has a beneficial impact\footnote{At 3$^{\text{rd}}$ generation light sources very restrictive pinholes and slits were used for spatial filtering with a dramatic loss of flux when improving and tuning the coherent fraction of the beam. Due to the increased coherent fraction at 4$^{\text{th}}$ generation sources, much less restrictive filtering is necessary, with higher photon transmission as a consequence.} for many applications requiring coherent beams, such as X-ray photon correlation spectroscopy, coherent diffraction imaging, propagation-based phase-contrast imaging, and ptychography \cite{paganin_book}.
%The migration to fourth-generation storage-rings has significantly improved brilliance and coherence of the X-ray synchrotron sources. This has a beneficial impact for many applications requiring coherent beams, such as X-ray photon correlation spectroscopy, coherent diffraction imaging, propagation-based phase-contrast imaging, and ptychography \cite{paganin_book}.
%The transverse coherenct fraction of the new sources is increased by at least one order of magnitude with respect the 3$^{\text{rd}}$ generation sources (typically from 10$^{-3}$ to 10$^{-2}$ at 10 keV). 
%At 3$^{\text{rd}}$ generation light sources, very restrictive pinholes and slits were used for spatial filtering with a dramatic loss of flux.
%A small pinhole was necessary with 3$^{\text{rd}}$ generation sources to gain coherence, with a dramatic loss of flux. Instead, at 4$^{\text{th}}$ generation sources, a slit with much higher transmittance is used to improve and tune the coherent fraction of the beam. 

The diffraction effects produced by the interaction of the beam with the boundaries and surface of the optical elements strongly affect the quality of the beam. These have a higher visibility due to the increased coherent fraction in 4$^{\text{th}}$ generation sources and its accurate modeling is fundamental for the design and optimization of beamlines. The physical models for the limiting cases of full incoherence (usually simulated by geometrical ray-tracing) or by propagating a single wavefront (valid for fully coherent radiation) are not sufficient for a complete understanding of the beam transport \cite{hierarchical}. The coherent fraction of the radiation emitted by new generation storage rings, although much improved with respect to previous generations, is still of the order of a few per cent at hard X-rays, which means that partial coherence should be taken into account. In the last years several modelling approaches have demonstrated to work for beamlines using undulator radiation. Starting from incoherent beams, \citeasnoun{codeHYBRID} proposed some correction algorithms to include diffraction effects that happen with coherent radiation. More accurate methodologies exploit the well-known propagation of coherent wavefronts. The partial coherence is treated by propagating a set of wavefronts that all together describe the undulator radiation. Two approaches are possible: one consists in calculating the wavefronts emitted by electrons entering in the undulator with different initial conditions, sampled by Monte Carlo from the electron beam emittance (multi-electron in SRW) \cite{codeSRW_ME}; and a second method that assigns these wavefronts to the coherent modes, eigenfunctions of the cross-spectral density (CSD), and are calculated numerically by making a coherent mode decomposition of the undulator source \cite{codeCOMSYL}.  


In this paper we propose a new method for dealing with partial coherence of undulator beams. The key point is to reduce the dimensionality of the problem to deal with 1D wavefronts cuts (i.e. separating horizontal and vertical directions). A full treatment of CMD with 2D wavefronts was implemented a few years ago in the COMSYL package \cite{glass2017}. This method requires the use of high-performance computer (HPC) clusters that are not always at a hand. The problem is to manipulate and diagonalize a huge stack representing the CSD, that is a 4D entity when using 2D wavefronts. Since then, different techniques have been applied to deal with the magnitude of the problem, for example using Single-Value-Decomposition for diagonalization \cite{SVDHanXu}, or analytical treatment of the quadratic phase \cite{ChubarCMD2022}, but none of them get rid of using HPC. In this paper we demonstrate that whenever this proposed 1D simplification can be used, in many cases so far, the results of are comparable to the other 2D methods but much less resource-intensive, thus allowing simulations in a simple laptop. 

% with gaining many orders of magnitude in computer resources, thus allowing simulations in a simple laptop. 
The new code is benchmarked against other existing codes that are available in OASYS simulation ecosystem \cite{codeOASYS}. The optical system used here derives from the project for the new ID18 beamline at the upgraded EBS-ESRF storage ring. We have compared results for different setups implementing two refractive systems (transfocators), plus a slit placed upstream from the transfocators. The focal spots produced by four different transfocator configuratiuons are studied in detail using four packages: i) the novel 1D CMD, implemented in the code WOFRY1D, ii) full CMD in 2D with COMSYL \cite{codeCOMSYL}, iii) multi-electron simulations as implemented in SRW \cite{codeSRW}, and iv) hybrid ray-tracing as described by \citeasnoun{codeHYBRID} and implemented in ShadowOUI \cite{codeSHADOWOUI}.

% To study the performances of such systems a new algorithm for coherent mode decomposition (CMD) of the undulator beams has been developed. This method is very fast allowing parametric simulations in a common laptop.

% The high efficiency of the CMD software developed is obtained by implementing a 1D model, therefore studying separately the horizontal and vertical planes. 

% Simulation of the source include coherent mode decomposition (CMD) using COMSYL \cite{codeCOMSYL}, or Monte-Carlo multi-electron propagation with SRW \cite{codeSRW}. It is also found that ray-tracing simulations using the ``hybrid" method \cite{codeHYBRID} give good approximations to the correct results for these systems. A simplified algorithm for CMD in 1D is available in WOFRY. It is very fast allowing parametric simulations in a common laptop, with results in good agreement with the other methods that require a computing cluster.

% The paper is organized as follows. Section~\ref{sec:theory} summarizes the methodology used for 1D coherent mode decomposition of undulator beams and their transport along the beamline. Section~\ref{sec:onelens} analyzes the focusing of partially-coherent beams with a single refractive system (lens). Section~\ref{sec:twolenses} discusses the pairing of two refractive systems. Section~\ref{sec:complete-beamline} shows simulations for the full beamline and compares different methodologies for a selected case. We finish with a general discussion in Section~\ref{sec:discussion} and  concluding remarks in Section~\ref{sec:summary}. 

% -----------------------------------------------------------------
% -----------------------------------------------------------------
\section{Methods for describing partial coherent beams from undulators in a storage ring}\label{sec:part_coh}
% -----------------------------------------------------------------
% -----------------------------------------------------------------
% In this section we present four methods used for dealing with partially-coherent x-ray beams emitted by undulators in low-emittance storage rings. Three of those are already-established methods:  hybrid ray-tracing in ShadowOUI; Monte Carlo multi-electron simulations as implemented in SRW; and the 2D-CDM method implemented in COMSYL. Despite being independently maintained and distributed projects, these are conveniently grouped together within the OASYS suit \cite{codeOASYS} and hence their choice for benchmarking. The fourth approach is the proposed 1D-CMD method separating the horizontal- and vertical-directions implemented in WOFRY, which is also featured in OASYS.

In this section we present the basic theory underneath partially coherent emission from electrons in storage rings. We start showing that a relativistic single electron emits fully coherent radiation when passing through an undulator magnetic field. We then move to the emission from relativistic electron bunches showing that an electron beam with non-negligible emittance will produce a partially coherent emission and that a higher coherent fraction is associated with a lower electron-beam emittance. Finally, we present the basic principles underlining the numeric calculations within the packages used.

%We start showing how the partial coherence appears when a bunch of electrons travels along the insertion device. Although a single electron emits coherent radiation, a beam of electrons in a emits partially coherent light: high coherence is associated with low emittance. 

% four methods used for dealing with partially-coherent x-ray beams emitted by undulators in low-emittance storage rings. Three of those are already-established methods: Monte Carlo multi-electron simulations as implemented in SRW; the 2D-CDM method implemented in COMSYL; and the hybrid ray-tracing in ShadowOUI. Despite being independently maintained and distributed projects, these are conveniently grouped together within the OASYS suit \cite{codeOASYS} and hence their choice for benchmarking. The fourth approach is the proposed 1D-CMD method separating the horizontal- and vertical-directions implemented in WOFRY, which is also featured in OASYS.

% -----------------------------------------------------------------
\subsection{Description of undulator emission}
\label{sec:undulator}
% -----------------------------------------------------------------

We quickly remind that an ultrarelativistic charged particle following a curved trajectory (usually wiggly as produced by alternated magnetic fields in insertion devices - ID) emits radiation. This electric field can be calculated in the framework of the classical electrodynamics - see e.g. Eq.~14.14 in \cite{jackson}. In the frequency domain the electric field at an observation point $\textbf{r}=(x,y,z)$ can be written as: 
\begin{equation}
\begin{split}
    E_{\omega}(\textbf{r}) = \frac{i e \omega}{4 \pi \epsilon_0} 
    \int_{-\infty}^{\infty}
    &\biggl[ 
    \frac{\textbf{n} \times [(\textbf{n} - \mathbf{\beta}) \times \dot{\mathbf{\beta}}]}
    {(1- \mathbf{\beta} \cdot \textbf{n})^\inred{2}} +\\
    &\qquad+\frac{c}{\gamma^2 R}   \frac{\textbf{n} - \mathbf{\beta}}{(1-\mathbf{\beta} \cdot \textbf{n})^3} \biggr]
    \exp^{i \omega (t - \textbf{n}\cdot\mathbf{\beta})} \mathrm{d}t
\end{split}\label{eq:undulator}
\end{equation}
where the subscript $\omega$ indicates the photon frequency, $e$ is the electron charge, $c$ the velocity of light, $\epsilon_0$ the electric constant, $\gamma=1957\mathcal{E}[\mathrm{GeV}]$ is the Lorentz factor with $\mathcal{E}$ being the electron energy in practical units, $\mathbf{\beta}=\mathbf{v}\big/c$ is the electron relative velocity and the dot in $\dot{\mathbf{\beta}}$ denotes the time derivative indicating the electron relative acceleration. Also $\textbf{n}(t)=\textbf{r}-\textbf{r}_{\textbf{e}}(t)\big/|\textbf{r}-\textbf{\inred{r}}_{\textbf{e}}(t)|$ is the unit vector pointing from the particle to the observation point $\textbf{r}$; the electron trajectory is represented by $\textbf{r}_{\textbf{e}}(t)$, which is completely determined by the 3D distribution of the magnetic field inside the ID and the electron initial conditions prior to entering it. The origin of the vector $\textbf{r}$ is usually at the center of the insertion device/straight section. Figure~\ref{fig:coordinates} serves as a visual aid to Eq.~\ref{eq:undulator} and its parameters. 

It has been pointed out by \citeasnoun{codeSRW} that Eq.~\ref{eq:undulator}, based on velocity and acceleration fields, is analytically equivalent to the approach based on retarded potentials applied in \cite{Chubar1995} for non-zero frequencies. Equation~\ref{eq:undulator} describes a fully spatially-coherent field and has been conceptualised for a single electron. A common abstraction that derives from it is the "filament beam", where $N_e$ electrons overlap in space following same trajectory $\textbf{r}_{\textbf{e}}(t)$, which is useful to  represent an idealized zero-emittance storage ring. In this case, a multiplicative factor $N_e$ is applied to Eq.~\ref{eq:undulator}. Much like the single electron emission, the filament beam also radiates a fully transverse coherent wavefront.

% where the retarded time $t'$ verifies $t=t'+R(t')$. 
% This equation permits to calculate the wavefront at a given frequency and at a given plane of coordinates $(x,y)$ distant $z_0$ from the origin, that is at $\textbf{r}=(x,y,z_0)$. The origin is usually set at the center of the insertion device (ID). Full transverse coherence is obtained as $E_{\omega}$ is unique and well-defined (amplitude and phase) in space.

% The previously discussed case is for a single electron, however if $N_e$ electrons followed exactly the same trajectory at the same time (an abstraction in that the electrons overlap in space) the intensity is $N_e$ times those obtained from Eq.~\ref{eq:undulator}. This abstraction is called "filament beam", and it is useful to represent an idealized zero-emittance ring. Much like the single electron emission, the filament beam also radiates a fully transverse coherent wavefront.

Several codes are available in the synchrotron community to calculate the undulator emission characteristics in different cases. The codes URGENT \cite{codeURGENT} and US \cite{codeUS} compute undulator emission in the far-field for undulators with sinusoidal magnetic field. The codes SPECTRA \cite{Tanaka2001} and SRW \cite{codeSRW} are more generic as they calculate emission in the near and far-field for any electron trajectory (with different initial conditions) and submitted to an arbitrary magnetic field.

\onecolumn
\begin{figure}\label{fig:coordinates}
    \centering
    \includegraphics[width=0.79\textwidth]{coordinates.pdf}
    \caption{Spontaneous emission of relativistic electrons and propagation of wavefronts along the beamline.}
\end{figure}
\twocolumn


% -----------------------------------------------------------------
\subsection{Electron beam distribution in storage rings}
\label{sec:electronbeam}
% -----------------------------------------------------------------

% The electron trajectory previously used $\textbf{r}_{\textbf{e}}(t)$ is completely determined by the map of the magnetic field of the ID and the initial conditions at the entrance of the ID. 

At any position position $s$ in the storage ring, an electron can be described by 5 coordinates:
$\mathcal{S}= (x_\text{e},y_\text{e},  \theta_{x_\text{e}}, \theta_{y_\text{e}},\delta_\mathcal{E})$ representing the phase space coordinates and a term $\delta_\mathcal{E}$ expressing the relative deviation of the electron energy from main storage ring energy (also known as the energy spread). It follows that at any given $s$ the many-electrons in a bunch follow a 5D Gaussian distribution:
\begin{equation}\label{eq:f-electrons}
f(\mathcal{S}) = \frac{1}{(2 \pi)^{5/2} \sqrt{\text{det}(M^{-1})}} \exp
        \left( -\frac{1}{2} \mathcal{S}^\text{T} M \mathcal{S} \right),
\end{equation}
with $M$ as the inverse of the generalized variance 5$\times$5 matrix. A common assumption in accelerator-based synchrotron radiation (SR) modelling is that these variables are uncorrelated. Then, only the diagonal terms in $M$ are non-zero: ($1/\sigma_x^2,1/\sigma_y^2,1/\sigma_{\theta_x}^2,1/\sigma_{\theta_y}^2,1/\delta_\mathcal{E}^2)$. We also assume that the electron bunch has a Gaussian distribution with $\sigma_z$ along the longitudinal direction, as most particle beams do - cf. \S8. in \cite{Wiedemann2015}.
%\todo{discuss longitudinal direction $\sigma_z$?}

% $f(\textbf{S}_\text{e})$. , with given r.m.s spatial ($\sigma_x$, $\sigma_y$, $\sigma_z$), angular ($\sigma_{x'}$,$\sigma_{y'}$), and energy $\delta$ values. Correlation terms are, in general, different from zero only for the horizontal ($\sigma_{x x'}$) and vertical ($\sigma_{y y'}$). 
 

% -----------------------------------------------------------------
\subsection{Emission from electron bunches}
% -----------------------------------------------------------------

Having summarized the coherent emission from a single electron in section \ref{sec:undulator} and how the electrons are statistically distributed in a bunch (section \ref{sec:electronbeam}), we now turn our attention to the emission from the electron bunch with finite emittance. %we to put them together to obtain the light emission from the electron bunch.

The total electric field emitted from all $N_e$ electrons in a bunch circulating in a storage ring is given by: 
\begin{equation}
    E_{\omega \text{~bunch}}(\textbf{r}) = \sum_{n=1}^{N_e} E_{\omega_{n}}(\textbf{r}).
\end{equation}
In terms of intensity: 
\begin{equation}
\begin{split}
|E_{\omega\text{~bunch}}(\textbf{r})|^2 \approx ~&N_\text{e} \int\big| E_\omega(\textbf{r};\mathcal{S})\big|^2 f(\mathcal{S})~ \text{d}\mathcal{S}~+\\
+~ &N_\text{e}(N_\text{e}-1)\bigg| \int E_\omega(\textbf{r};\mathcal{S}) f(\mathcal{S})~ \text{d}\mathcal{S} \bigg|^2.
\end{split}
\label{eq:SR}
\end{equation}
The electric field $E_\omega(\textbf{r};\mathcal{S})$ is the emission by a single electron with trajectory defined by the undulator magnetic field and electron initial conditions $\mathcal{S}$ with $s=s_0$ at the observation point $\textbf{r}$ - see Eq.~\ref{eq:undulator}. The first term in Eq.~\ref{eq:SR} is a sum at $\textbf{r}$ of the intensity of every electron emission weighted by its probability $f$, which describes temporally incoherent SR. The second term stands for the enhancement of the intensity due to coherent superposition of the emission of the $N_e$ electrons, modelling temporally coherent SR. It follows that: $\text{I}_\text{~bunch} = \text{I}_\text{~iSR}+\text{I}_\text{~cSR}$. For emitted wavelengths shorter than the electron bunch length (closely packed electrons, i.e. when $\sigma_z < \lambda$, $\lambda$ being the photon wavelength), the power associated with the term $\text{I}_\text{~cSR}$ vanishes quickly \cite{CSR,Wiedemann2015}. Considering typical undulator radiation emission, i.e. x-ray energy ranges from a few hundred electron-volts to a few hundred keV, and typical electron bunch lengths in storage rings ($\sigma_{T}>30$~ps), $\text{I}_\text{~cSR}$ can be neglected when considering standard monochromatisation schemes in beamlines\footnote{\citeasnoun{geloni2008} provide a counter-example in Ref[15] ibid.}.


% Typically, the second term in Eq.~\ref{eq:SR} is non negligible for closely packed electrons,i.e. when $\sigma_z < \lambda$ ($\lambda$ is the photon wavelength). In other words, the first term in the sum describes temporally incoherent SR and the second term models temporally coherent SR: $\text{I}_\text{~bunch} = \text{I}_\text{~iSR}+\text{I}_\text{~cSR}$. For emitted wavelengths shorter than the electron bunch length, the power associated with the term $\text{I}_\text{~cSR}$ vanishes quickly \cite{CSR,Wiedemann2015}.
% Considering typical undulator radiation emission, i.e. x-ray energy ranges from a few hundred electron-volts to a few hundred keV, and typical electron bunch lengths in storage rings ($\sigma_{T}>30$~ps), $\text{I}_\text{~cSR}$ can be neglected when considering standard monochromatisation schemes in beamlines. %\todo{ I WOULD REMOVE THIS: A further simplification to Eq.~\ref{eq:SR} is done when considering that the intensity of the single-electron emission is not dependent on the initial electron position $z_\text{e}$. The integration of Eq.~\ref{eq:SR} can then be done in 5 dimensions.}

In a similar way, the mutual correlation of the electric field between two observation points $\textbf{r}_1$ and $\textbf{r}_2$ is:
\begin{equation}\label{eq:CSDallaChubar}
\begin{split}
      &\big\langle E^*_{\omega}(\textbf{r}_1) E_{\omega}(\textbf{r}_2)\big\rangle = \\
      &\quad = \sum_{m=1}^{N_e} \sum_{n=1}^{N_e} E^*_{\omega_{m}}(\textbf{r}_1) E_{\omega_{n}}(\textbf{r}_2)\\
      &\quad = N_e^\inred{2}\iint
      E^*_{\omega}(\textbf{r}_1;\mathcal{S}_1)
      E_{\omega}(\textbf{r}_2;\mathcal{S}_2)
      f(\mathcal{S}_1) f(\mathcal{S}_2)~
      \text{d}\textbf{S}_1 \text{d}\textbf{S}_2,
\end{split}
\end{equation}
where $\bullet^*$ indicates the complex conjugate, the brackets $\langle \bullet \rangle$ indicate sum over the bunches, $\textbf{r}_1=(x_1,y_1,z_1)$ and $\textbf{r}_2=(x_2,y_2,z_2)$ - see Fig.~\ref{fig:coordinates}. This equation is the cross-spectral density, that will be discussed later and rewritten in more manageable form.

% This implies necessarily some mathematical tools, probably using convolution. 
% Indeed, Kwang-Je Kim developed a propagation theory of synchrotron radiation using Wigner distribution \cite{KimConvolution}. He introduced the ``brightness convolution theorem" stating that the source brightness due to a collection of electrons randomly distributed in their phase space is calculated by a convolution of the source brightness due to a reference electron with the electron distribution function. 

% where $E_{\omega\text{~bunch}}(\textbf{r})\equiv E_{\text{~bunch}}(x,y, z;\omega)$ is the resulting bunch emission; $E_\omega(\textbf{r})\equiv E(x,y, z;\omega)$ is the single-electron emission; 
% $\textbf{s}_\text{e}=(x_\text{e},y_\text{e},z_\text{e})$ represents the electrons initial positions,

% $\textbf{s}'_\text{e}=(x'_\text{e},y'_\text{e})$ gives the electrons initial directions and $\gamma_\text{e}$ is the electron-beam energy subjected to the energy spread $\delta \gamma_\text{e}$. These variables are uncorrelated and have Gaussian distribution in a 6-dimensional space \cite{codeSRW_CSR}. 

% The single-electron emission $E_\omega(\textbf{r})$ is, by definition, fully coherent\footnote{A similar abstraction is the zero-emittance or filament beam, that also radiates a fully transverse coherent wavefront, but with an intensity proportional to $N_e$.}. 

% -----------------------------------------------------------------
\subsection{Multi-electron Monte Carlo (SRW-ME)}
% -----------------------------------------------------------------

Synchrotron radiation emitted by undulators in storage rings is a fundamentally random process and should be treated probabilistic. The SRW-ME algorithm used to account for partial coherence implements Eq.~\ref{eq:SR} by individually calculating the SR emission of several electrons subjected to the initial conditions sampled from $f(\mathcal{S})$ assuming these are uncorrelated and passing through an arbitrary magnetic field describing the x-ray source. Each resulting electric field from this Monte-Carlo sampling is then propagated through the beamline until the observation point, where the contributions from different electrons are added in intensity \cite{codeSRW_ME}. It is impractical (and unnecessary) to account for the emission of every single electron in a beam that very often has a current of few hundreds mA. Electrons are then divided in so-called macro-electrons (\textit{me's}), which is an abstraction that allows to group the emission of several individual electrons into one ``superparticle'' emitting a fully-coherent wavefront but with resulting intensity given by the total intensity $\text{I}_\text{~bunch}$ divided by the number of macro-electrons $N_{me's}$ used in the simulation:
\begin{equation}
% \begin{split}
|E_{\omega\text{~bunch}}(\textbf{r})|^2 \approx \frac{N_e}{N_{me's}}\sum_{n=0}^{N_{me's} - 1}\big| E_\omega(\textbf{r};\mathcal{S}_n)\big|^2.
% \end{split}
\label{eq:SR_SRW}
\end{equation}
Equation~\ref{eq:SR_SRW} can be expressed\footnote{See also the works by \citeasnoun{hulbert1992} and \citeasnoun{kim1995}.} in number of photons ($\text{d}N_{ph}$) per unity of time ($\text{d}t$) per unit surface ($\text{d}\Sigma$) per per unit relative bandwidth ($\text{d}\omega\big/\omega$) by:
\begin{equation}
\frac{\text{d}N_{ph}}{\text{d}t~\text{d}\Sigma~\text{d}\omega\big/\omega}=\frac{c^2\alpha \text{I}_\text{~bunch}}{4\pi^2e^3N_e}|E_{\omega\text{~bunch}}(\textbf{r})|^2,
\label{eq:SR_ph}
\end{equation}
where $\alpha$ is the fine-structure constant, $\text{I}_\text{~bunch}$ is the storage ring current \cite{Chubar1995}.

An advantage of the SRW-ME approach is that the electric fields of the \textit{me's} propagate independently from each other, which allows a convenient parallelisation of the wavefront propagations among many processors, requiring the use of HPC in most cases.

% -----------------------------------------------------------------
\subsection{Coherent mode decomposition of undulator radiation}\label{sec:CMD}
% -----------------------------------------------------------------

The cross-spectral density, generally represented as:
\begin{equation}
W_\text{2D}(\textbf{r}_1,\textbf{r}_2;\omega) = \big\langle E^*_{\omega}(\textbf{r}_1)  E_{\omega}(\textbf{r}_2)\big\rangle,
\label{eq:CSD_2D}
\end{equation}
expresses the correlation of the emitted radiation between any two spatial points $\textbf{r}_1$ and $\textbf{r}_2$. It is the fundamental object that we will use to describe all partially-coherent properties of the synchrotron beams. We justify first, in the context of existing literature, the conditions of its usage for synchrotron light. Then we present the CMD and its practical implementation in 2D (with COMSYL) and the proposed 1D algorithm (with WOFRY1D).   

% expresses the correlation of the emitted radiation between any two spatial points $\textbf{r}_1$ and $\textbf{r}_2$. It is the fundamental object that we will use to describe all partial coherence properties of the synchrotron beams. It completely describes and quantified the ``partial coherence" of these beams. We justify first, in the context of existing literature, the conditions of its usage for synchrotron light. Then we present the CMD and its practical implementation in 2D (with COMSYL) and the new 1D algorithm (with WOFRY1D).   


% -----------------------------------------------------------------
\subsubsection{Validity of CSD usage for emission in storage rings\\}\label{sec:validity}
% -----------------------------------------------------------------

\citeasnoun{geloni2008} show that although SR emission (a random process obeying Gaussian statistics) is not intrinsically stationary nor homogeneous, second order coherence theory of scalar fields as presented by \citeasnoun{mandel_wolf} can be applied when the following conditions are observed:
\begin{enumerate}[label=(\roman*)]
\item radiation frequency $\omega$ is ``sufficiently high";
\item $e$-bunch length $\sigma_{T}$ ``sufficiently large" so that $\omega\sigma_{T}\gg1$;
\item radiation bandwidth $\Delta_\omega$ is not ``too narrow" ($\Delta_\omega\gg1\big/\sigma_{T}$).
\end{enumerate}
Basically excluding infra-red downwards, condition (i) holds for soft- to hard x-rays, which are upwards in frequency; condition (ii) is satisfied by storage rings, where typically $\sigma_{T}>30$~ps, but not at free-electron lasers, where $\sigma_{T}<0.1$~ps due to micro-bunching effects; and finally, condition (iii) is generally met by standard monochromatisation schemes. This set of conditions, related to the longitudinal electron-beam direction, ensures that SR emission is a quasi-stationary (or a wide-sense stationary) process. 

In the (2D) transverse direction, when the intensity slowly varies compared to the coherence length we consider undulator radiation to be quasi-homogeneous. Conditions for such are implicitly met when: 
\begin{enumerate}[label=(\roman*)]
\setcounter{enumi}{3}
\item $N_\text{x}\gg1$ and $D_\text{x}\gg1$ (or equivalently $\varepsilon_x\big/\lambdabar\gg1$);
\item $N_\text{y}\gg1$ and/or $D_\text{y}\gg1$,
\end{enumerate}
with:
\begin{equation}
    N_\text{x,y}=\frac{\sigma^2_\text{x,y}}{\lambdabar L_u}, \quad D_\text{x,y}=\frac{\sigma'^2_\text{x,y}}{\lambdabar/L_u}
\end{equation}
where $\sigma_\text{x,y}$ and $\sigma'_\text{x,y}$ represent the electron beam transverse sizes and divergences, $L_u$ is the undulator length (number of periods $N_u$ times the magnetic period $\lambda_u$) and $\lambdabar=\lambda/2\pi$. We remind the reader that the electron beam transverse sizes and divergences are both proportional to the square root of the the electron beam emittance $\varepsilon_\text{x,y}$. (Quasi-) homogeneous sources have the property that the cross-spectral density in Eq.~\ref{eq:CSD_2D} can be factorised as a multiplication of a horizontal and a vertical cross-spectral densities - a result that will be explored in more details in \S\ref{sec:WOFRY1D}. \inred{For third-generation synchrotron light sources,} conditions (iv) and (v) are met for the wavelengths already restricted by (i) and as noted by \citeasnoun{geloni2008}, the conditions (i)-(v) are practically non-restrictive under cases of practical interest. \inred{As the horizontal emittance starts to become smaller, as it is the case with fourth-gen. light sources, we start \textbf{slowly} approaching a region where quasi-homogeneity breaks down.}

% -----------------------------------------------------------------
\subsubsection{Coherent modes, coherent fraction and coherent length\\}
% -----------------------------------------------------------------

The CSD in Eq.~\ref{eq:CSD_2D} is used to define the spectral density\footnote{Which is sometimes loosely called intensity. The spectrum density and the intensity functions are equivalent for the quasi-monochromatic case. The same holds for the CSD and the mutual optical intensity (MOI) \cite{mandel_wolf}.} as:
\begin{equation}\label{eq:intensity}
    I_\text{2D}(\textbf{r};\omega)=W_\text{2D}(\textbf{r},\textbf{r};\omega),
\end{equation}
for the case where $\textbf{r}=\textbf{r}_1=\textbf{r}_2$. We also define the normalised cross-spectral density function or spectral degree of coherence (SDC) as:
\begin{equation}
\mu(\textbf{r}_1,\textbf{r}_2;\omega) = \frac{W_\text{2D}(\textbf{r}_1,\textbf{r}_2;\omega)}{\sqrt{I_\text{2D}(\textbf{r}_1;\omega) I_\text{2D}(\textbf{r}_2;\omega)}}.
\label{eq:DTC}
\end{equation}
The absolute value of Eq.~\ref{eq:DTC} is limited to $0\leq|\mu(\textbf{r}_1,\textbf{r}_2;\omega)|\leq 1$, where $|\mu|=0$ means total uncorrelation and $|\mu|=1$ denotes full correlation of the fluctuations at positions $\textbf{r}_1$ and $\textbf{r}_2$.

A well known result from coherence theory is the coherent mode representation of partially coherent fields in free-space - see ยง4.7.1 in \cite{mandel_wolf}. It is possible to decompose the CSD in a infinite sum of orthonormal coherent modes:
\begin{equation}\label{eq:W2DCMD}
W_\text{2D}(\textbf{r}_1,\textbf{r}_2;\omega) = \sum_{n=0}^{\infty} \Lambda_n(\omega) \Phi_{n}^*(\textbf{r}_1;\omega) \Phi_{n}(\textbf{r}_2;\omega)
\end{equation}
where $\Lambda_n$ (eigenvalues) are the intensity weights and the $\Phi$ are the coherent modes (eigenfunctions). 
Some important characteristics of this coherent mode decomposition are: 

\begin{enumerate}[label=(\roman*)]
\item the modes $\Phi$ are orthonormal in the integral sense;
% \end{enumerate}
% \begin{equation*}
% \int W_\text{2D}(\textbf{r}_1,\textbf{r}_2;\omega)  \Phi_{n}(\textbf{r}_1;\omega)~ \text{d}\textbf{r}_1 = \Lambda_n(\omega) \Phi_{n}(\textbf{r}_2;\omega);
% % \label{eq:orthonormal_modes}
% \end{equation*}
% \begin{enumerate}[label=(\roman*)]
% \setcounter{enumi}{1}
\item the modes maximize the CSD making the truncation optimal:
\end{enumerate}
\begin{equation*}
\Lambda(\omega) \in \mathbb{R}
:~0\leq \Lambda_{i+1}(\omega)<\Lambda_i(\omega);~\forall~i \in \mathbb{N};
\end{equation*}
\begin{enumerate}[label=(\roman*)]
\setcounter{enumi}{2}
\item the eigenvalues $\Lambda_n$ are a measure of the intensity of the corresponding mode $\Phi_{n}$; 
\item we define the occupation $\eta$ of the i-th mode as the normalized intensity: 
\begin{equation}
\eta_i(\omega) =\frac{\Lambda_i(\omega)}{\sum\limits_{n=0}^\infty{\Lambda_n(\omega)}};
\end{equation}
\item radiation is considered fully-coherent if and only if there is only a single mode.
\end{enumerate}

From these arguments, it is now natural to rigorously define coherent fraction ($\text{CF}_\text{2D}$) as the occupation of the first coherent mode:
\begin{equation}
\text{CF}_\text{2D}=\eta_0=\frac{\Lambda_0(\omega)}{\sum\limits_{n=0}^\infty{\Lambda_n(\omega)}}. \label{eq:CF2D}
\end{equation}
When using evaluating the CF of a particular optical setup, it is relevant to consider that if there is spatial filtering or any sort of beam clipping the modes $\Phi$ do not propagate retaining their orthogonality and their occupation $\eta$. In this case, a reapplication of the CMD to the cropped modes (rediagonalisation) is imperative to recalculate the new $\text{CF}_\text{2D}$.

We also define the transverse coherence length (CL) based on the width of the first mode $\Phi_0$, acknowledging issues with this definition arising mainly from the fact that here is no unanimous accepted way of defining the beam width. However, given the importance of such parameter for daily beamline operations (eg. choosing slit sizes) and that blindly applying the van-Cittert-Zernike (VCZ) theorem may lead to errors - cf. ยง4.1 in \cite{geloni2008}, we decided to put the CL on a firmer footing. This definition holds for both horizontal directions and is dependent on the criteria used for defining the beam width along that direction. % \todo{a possible new section describing the coherent parameters (CF, coherent length, etc) and the way to obtain them via rediagonalization...}

The interest of the coherent mode decomposition method in optical design of x-ray beamlines is manyfold: i) the possibility of propagating a partially-coherent beam along a beamline by just propagating a few hundred modes which behave like coherent wavefronts as opposed to a few thousand wavefronts when doing multi-electron Monte-Carlo simulations; ii) the use of the coherent fraction (a scalar parameter) as a well-defined measure of how coherent is the beam at any position of the beamline; iii) the numerical storage of the $N_m$ modes that depend on two spatial variables is more economic than the storage of the cross-spectral density $W$ that depends on four variables; and iv) the infinite series converges smoothly to the CSD, therefore the truncation at a limited number of modes $N_m$ always guarantees that it is the best possible reduced representation of the CSD and can be quantified.% (usually $N_m$ is chosen to get the 99\% of the spectral density). 

% -----------------------------------------------------------------
\subsubsection{Coherent mode decomposition with COMSYL\\}\label{sec:COMSYL} 
% -----------------------------------------------------------------
 COMSYL (COherent Modes for Synchrotron Light) is a software package to perform the CMD of undulator radiation in an storage ring \cite{codeCOMSYL}. A complete description of the code is given by \citeasnoun{glassThesis} and here we summarize principles underlying it. Applications of this software for beamline modelling at the ESRF-EBS are in presented in \cite{glass2017, hierarchical}. 


Coherent mode decomposition consists in calculating $\Lambda_i$ and $\Phi_i$ in equation \ref{eq:W2DCMD}. This operation can be seen as the diagonalization of $W_{2D}$ where the eigenfunctions are the coherent modes ($\Phi_i$) and the eigenvalues their intensity weights ($\Lambda_i$). These are the solution of the homogeneous Fredholm integral equation of second kind:

\begin{equation}\label{fredholm_equation}
\int W_{2D}(\textbf{r}_1,\textbf{r}_2;\omega)
\Phi_i(\textbf{r}_1;\omega)~\text{d}\textbf{r}_1  = \Lambda_i(\omega) \Phi_i(\inred{\textbf{r}_2},\omega)
\end{equation}
The eigenvalue in Eq.~\ref{fredholm_equation} can be written: 
\begin{equation}
A_{W_{2D}}[\Phi_i] = \Lambda_i \Phi_i,
\end{equation}
where we define the Hermitian operator for a generic function $g$ as:
\begin{equation}\label{eq:Hermitian}
A_{W_{2D}}[g](\textbf{r})  = \int W_{2D}(\tilde{\textbf{r}},\textbf{r};\omega) g(\tilde{\textbf{r}})~ \text{d}\tilde{\textbf{r}}.
\end{equation}

We concentrate now in methods for efficiently obtaining $W_{2D}$. A first look at the CSD expression (see Eq.~\ref{eq:CSDallaChubar}) is enough to get an impression of how it is resource-intensive calculating and storing this 6D function. For synchrotron beams it is useful to decouple the longitudinal coordinate (along the optical axis in a beamline - see Fig.~\ref{fig:coordinates}) so that $W_{2D}$ reduces to 4D. Knowing the CSD at a given position $z$, that is, $W_{2D}(x_1,y_1,x_2,y_2; \omega, z)$ it is possible (although not simple) to propagate it to another position $z'$ and even at the origin of the optical axis (the source position).

Kwang-Je \citeasnoun{KimConvolution} developed a propagation theory of synchrotron radiation using Wigner distribution. He introduced the ``brightness convolution theorem" stating that the source brightness due to a collection of electrons randomly distributed in their phase space is calculated by a convolution of the source brightness due to a reference electron with the electron distribution function. 
Kim's brightness convolution theorem is applied in a plane $(s_x,s_y)$ at $s_0=-L_u\big/2$, which is where the  electrons enter in the undulator. This distance $s_0$ is taken from the center of the ID (origin of optical axis) - see Fig.~\ref{fig:coordinates}. We have [cf. Eq.~3.37 in \cite{glassThesis}]:
\begin{equation}\label{eq:comsyl_W2D}
\begin{split}
& W_\text{2D}(\textbf{r}_1,\textbf{r}_2;\omega) = \\
&\qquad=\int E_\omega^*(\textbf{r}_1-\textbf{r}_e)
    E_\omega(\textbf{r}_2-\textbf{r}_e) \exp(i k \mathbf{\theta}_e\Delta\textbf{r})f(\mathcal{S})~\text{d}\mathcal{S},
\end{split}
\end{equation}
where $\textbf{r}_e=(x_e,y_e)$, $\mathbf{\theta}_e=(\theta_{x_e},\theta_{y_e})$ and $\Delta\textbf{r}=\textbf{r}_2-\textbf{r}_1$. Note that this is a 4D function as the third spatial coordinate is fixed to $s_0$. Using SRW, the electric field $E_\omega$ is calculated in an arbitrary plane at a distance $z$ and then backpropagated to $s_0$ with the standard Fresnel free-space propagator (see Apendix~\ref{sec:appendixSRWpropagators}).


% \begin{equation}\label{eq:comsyl_W2D}
%     W_\text{2D}(\textbf{r}_1,\textbf{r}_2;\omega) = \int     E_\omega^*(\textbf{r}_1-\textbf{r})
%     E_\omega(\textbf{r}_2-\textbf{r})F(\textbf{r}, \Delta \textbf{r})~\text{d}\delta_\mathcal{E}\text{d}\textbf{r},
% \end{equation}
% where $\Delta\textbf{r}=\textbf{r}_2-\textbf{r}_1$ and: 
% \begin{equation}
% F(\textbf{r},\mathbf{\Delta}\textbf{r}) = \int d\textbf{r}' f(\textbf{r},\textbf{r'},\delta) \exp(i k \textbf{r}'\Delta\textbf{r}),
% \end{equation}
% and $f$ the 5D distribution of the electrons (equation \ref{eq:f-electrons}).
% Note that this is a 4D function as the third coordinate is fixed to $z_e$, so  now $\textbf{r}=(x,y)$ and $\textbf{r}'=(x',y')$. 
% $E_\omega$ is calculates using SRW in an arbitrary plane ($z_D$) and then backpropagated to $z_e$ with a Fresnel standard SRW propagator (see below).

 
COMSYL starts with a matrix method that discretizes the cross spectral density operator $A_{W_{2D}}$ in a step function basis set [see Eq.~4.4 in \cite{glassThesis}]. The discretization is followed by an iterative diagonalization using SLEPc \cite{SLEPc}. The implementation uses parallel computation and requires the use of a HPC. The key point of COMSYL is to avoid storing the full representing matrix, because it requires a lot of memory and computational resources. It scales essentially with $N_x^2 \times N_y^2$ where $N_x$ and $N_y$ are the numbers of grid points in the $x$ and $y$ dimension, respectively. Typical sizes for $N_x$ and $N_y$ can easily reach a few hundred up to a few thousand. In the latter case the memory requirements would reach several thousand terabytes. To reduce the memory requirements of the matrix method, COMSYL uses a two-step method that first performs a coherent mode decomposition for a zero divergence electron beam and based on this decomposition performs a second decomposition that takes the divergence into account. The memory requirement for our undulator applications is drastically reduced to about $4 \times N_x \times N_y \times N_m$ where $N_m$ is the number of requested coherent modes. This allows the calculation of higher harmonics or higher emittance rings where $N_x \times N_y \gg N_m$. 

The modes calculated with the just-described method can be propagated along the beamline and used to compute the spectral density and cross-spectral density at any point of the beamline. These modes can be conveniently propagated downstream a beamline with SRW or WOFRY using the OASYS environment - see \S\ref{sec:propagation}. However, due to modifications by optical elements (cropping/truncation and/or absorption), the propagated wavefronts generally lose their orthonormality. Thus, for computing the CF at a given point of the beamline, it is necessary to perform a new CMD with the propagated CSD. It is possible to apply the very same method used to compute the initial coherent modes, but COMSYL implements the action of the integral operator \inred{(\ref{eq:})} directly in terms of the coherent modes, which is much more economic in terms of memory.
% \inred{Question to @Manolo: talk about other codes that do CMD for X-ray simulations? xrt, MOI, SRW-CMD?

% Manolo's answer: Yes if they effectively do CMD on undulators: I think SRW-CMD and \cite{SVDHanXu} do that. I cited them before, stressing that they do not solve the problem of using HPC. We cannot say much about them as we do not have experience with them... MOI uses Gaussian-Shell model (not cited).  We should check again XRT and TANAKA...}

% -----------------------------------------------------------------
\subsubsection{1D coherent mode decomposition: separating horizontal and vertical directions (WOFRY)\\}\label{sec:WOFRY1D}
% -----------------------------------------------------------------

Resuming the discussion in \S\ref{sec:validity}, we now assume to be in a quasi-homogeneous regime. This allow us to decompose the CSD in Eq.~\ref{eq:CSD_2D} as a product of a horizontal- and a vertical cross-spectral densities:
\begin{equation}\label{eq:CSD_2D_bis}
\begin{split}
W_\text{2D}(\textbf{r}_1,\textbf{r}_2;\omega) &= W_\text{2D}(\textbf{r}_1,\textbf{r}_2;\omega)\big\rvert_{y_1=y_2=0} \cdot W_\text{2D}(\textbf{r}_1,\textbf{r}_2;\omega)\big\rvert_{x_1=x_2=0}\\
&= W_\text{1D}(x_1,x_2;\omega)\cdot W_\text{1D}(y_1,y_2;\omega).
\end{split}
\end{equation}
The CMD for each direction is:
\begin{equation}\begin{split}
W(r_1,r_2;\omega) &= \big\langle E^*_{\omega}(r_1) E_{\omega}(r_2)\big\rangle \\&=  \sum_{n=0}^{\infty} \lambda_n(\omega) \phi_n^*(r_1;\omega) \phi_n(r_2;\omega) 
\end{split}\label{eq:CMD1D}
\end{equation}
with $\lambda_n$ the 1D eigenvalues and $\phi_n$ the 1D eigenfunctions. The CSD described in Eq.~\ref{eq:CMD1D} is now a 2D function. This reduction in dimension is very welcome as it becomes very easy to store, manipulate and diagonalize the CSD using common tools (eg. numpy and scipy). Much like what was presented in \S\ref{sec:COMSYL} for the COMSYL software,  we calculate the 1D UR emission at an arbitrary plane located at $z$ from the origin - this time using pySRU \cite{pySRU} - and propagate this field back to $s_0=-L_u\big/2$ using WOFRY's zoom propagator (See Appendix~\ref{sec:appendixWOFRYpropagators}). The 2D CSD at $s_0$ is then obtained using Kim's brightness convolution theorem, which is effectively constructed using equation 3.51 in \cite{glass2017}.

This recipe is implemented in the WOFRY wavefront propagation package in OASYS. For a typical beamline, two calculations are done: one for the horizontal direction and another for the vertical. These two results are when combined: $W_\text{2D}(\textbf{r}_1,\textbf{r}_2;\omega)=W(x_1,x_2;\omega) W(y_1,y_2;\omega)$, implying numerical tensor operations. Similarly, the 2D wavefront intensity is retrieved as $I_\text{2D}(x,y)=I(x) I(y)$ - this will be extensively used in later sections; Note that if intensity is stored in arrays, the product is indeed an outer product. Finally, this decomposition gives raise to two values of coherence fraction: one for the horizontal- and one for the vertical direction. The 2D CF can be retrieved as $\text{CF}_{2D}=\text{CF}_{x}\text{CF}_{y}$. Like in COMSYL, the $\phi_n$ eigenfunctions can be are propagated to any position of the beamline like standard wavefronts. The propagated $W$ is then rediagonalized to obtain CF. 

% Calling $\phi'$ the wavefront originated by propagating the (source) mode $\phi$, we can construct the propagated CSD    
% \begin{equation}
% W'(x_1,x_2;\omega) = \sum_{n=0}^{\infty} \lambda_n(\omega) \phi'^{*}_n(x_1;\omega) \phi'_n(x_2;\omega).
% \label{eq:propagatedCSD}
% \end{equation}

The factorisation in Eq.~\ref{eq:CSD_2D_bis} has been discussed ยง3.1 from \cite{geloni2008} - see Eq.~56 ibid; where it is stated that this rearranging of Eq.~\ref{eq:CSD_2D} is only valid for quasi-homogeneous sources - see \S\ref{sec:validity}. In the context of the Wigner distribution, this separation in horizontal and vertical components has been discussed by various authors and is believed to work well for photon energies not far from the undulator resonance and for non-round beams \cite{Bazarov2012,tanaka2014,nash2021} - \inred{a discussion of round beams is given by \citeasnoun{Agarwal2000}; see also \S2.2.1 in \cite{Gasbarro2014}}. The CSD and the Wigner distribution being related by a Fourier transform - cf. \S III in \cite{Bazarov2012}.


% -----------------------------------------------------------------
% -----------------------------------------------------------------
\subsection{Hybrid ray-tracing (ShadowOUI)}
% -----------------------------------------------------------------
% -----------------------------------------------------------------

Ray-tracing-based methods are simpler and faster than wave-optics-based methods and more often than not, offer useful insight when studying and designing a synchrotron beamline \cite{hierarchical}. However, the use of pure ray-tracing methods based in geometrical optics are not very adequate when analyzing optical systems dealing with (partially- or fully-) coherent beams subjected to strong diffraction effects - eg. beam clipping by either physical acceptance of an optical element or by slits; and optical errors. To the geometric methods, it is possible to add diffraction effects by convolution of the beam divergence profiles calculated by ray-tracing and by applying the diffraction integrals, then proceeding with classical ray-tracing methods for treating optical elements and free-space propagation. Building on that hybrid concept, an extension to the ray-tracing code SHADOW \cite{codeSHADOW} has been proposed by \citeasnoun{codeHYBRID}, which is fully integrated in the ShadowOUI \cite{codeSHADOWOUI} add-on in OASYS. Since its release, this hybrid ray-tracing implementation has been successfully used as an efficient and fast tool to design beamlines also including coherence effects \cite{Shi2017,Luca2020, Lordano2022}.

% \onecolumn
\begin{figure}\label{fig:sim_meth}
    \centering
    \includegraphics[width=0.99\textwidth]{simulation_methods.pdf}
    \caption{Simulation methods. The circular arrows in \textit{c)} indicate the hybrid algorithm application - see Fig.~1 in \cite{codeHYBRID}.}
\end{figure}
% \twocolumn


% -----------------------------------------------------------------
% -----------------------------------------------------------------
\section{Propagation of wavefronts along the beamline}\label{sec:propagation}
% -----------------------------------------------------------------
% -----------------------------------------------------------------
 \newline

In terms of design using physical optics, an x-ray beamline is composed of two main elements: drift spaces and optical elements. The first category is handled with diffraction integrals and a brief explanation of the wavefront propagators used by the software in section~\ref{sec:part_coh} is presented here. Optical elements can usually be represented by transmission elements and this treatment is also covered in this section. 

% -----------------------------------------------------------------
% -----------------------------------------------------------------
\subsection{Drift spaces}\label{sec:free_space}
% -----------------------------------------------------------------
% -----------------------------------------------------------------

Under the scalar theory, a generic wavefront obeying the wave-equation and completely described at a position $z$, that is, $E_\omega(\textbf{r})$ known for all the $xy-$plane will propagate (evolve) between two parallel planes separated by a distance $L=z'-z$ as: 
\begin{equation}\label{eq:Huygens-Fresnel}
    E_\omega(\textbf{r}') = \frac{k}{2\pi i}\int\limits_{\Sigma}{E_\omega(\textbf{r})\frac{\exp{(ik\vert\textbf{r}' - \textbf{r}\vert)}}{\vert\textbf{r}' - \textbf{r}\vert}\cos{(\theta)}~\mathrm{d}\textbf{s}}.
\end{equation}
Eq.~\ref{eq:Huygens-Fresnel} is the first Rayleigh-Sommerfeld diffraction equation (Huygens-Fresnel principle) and is valid for the case where $\vert\textbf{r}' - \textbf{r}\vert\gg\lambda$, with $\lambda=2\pi \big/ k$. We define a normal vector parallel to the optical axis ($z-$axis) $\vec{\ell}$ so that $\theta$ is the angle between $-\vec{\ell}$ and the vector $\textbf{r}'-\textbf{r}$; $\Sigma$ is the $xy-$plane in $z$ where the integration takes place with $\mathrm{d}\textbf{s}=\mathrm{d}x\mathrm{d}y$ - see Fig.~\ref{fig:coordinates}. Further simplification to Eq.~\ref{eq:Huygens-Fresnel} can be done using the paraxial approximation. In this case, it is assumed that $\cos{(\theta)}\approx1$; and that the term $\vert\textbf{r}' - \textbf{r}\vert=\sqrt{(x'-x)^2 + (y'-y)^2 + L^2}$ can be expanded in a Taylor series with $L^2\gg(x'-x)^2$ and $L^2\gg(y'-y)^2$. Retaining the quadratic term in the exponential function, but dropping it for the denominator:
\begin{equation}\label{eq:Fresnel}
\begin{split}
    E_\omega(\textbf{r}') = &\frac{k\exp{(ikL)}}{2\pi i L}\cdot \\
    &\quad\cdot\int\limits_{\Sigma}{E_\omega(\textbf{r})\exp{\bigg\{ \frac{ik}{2L}\big[ (x'-x)^2 + (y'-y)^2 \big]\bigg\}}~\mathrm{d}\textbf{s}}.
\end{split}
\end{equation}
This approximation is know as the Fresnel diffraction integral and strategies for its numerical calculation are plenty: \cite{Kelly2014,Goodman2017} see also \cite{Rees87, Stern2004, Zhang2020} for other practical considerations.

The different wave-optics packages in use have different implementation of these propagators. The selection of the propagator, and its parametrization (sampling, padding, interpolation, etc.) is done depending on the particular characteristics of the optical element and propagation distances. SRW uses four different propagators, summarized in Appendix~\ref{sec:appendixSRWpropagators}. WOFRY basically uses two different propagaors (Appendix~\ref{sec:appendixWOFRYpropagators}).   

% % -----------------------------------------------------------------
% % -----------------------------------------------------------------
% \subsubsection{The SRW propagators}
% % -----------------------------------------------------------------
% % -----------------------------------------------------------------
%  are grouped into three main methods for 2D wavefront propagation \cite{SRWgit}. The first main method lies under the ``standard Fresnel propagator'', which can be implemented as: (a) direct numerical calculation of the convolution integral in Eq.~\ref{eq:Fresnel} by means of nested Riemann summations; or (b) through the application of the convolution theorem:
%  \begin{equation}\label{eq:FresnelConv}
% \begin{split}
%     E_\omega(\textbf{r}')&=\frac{k\exp{(ikL)}}{2\pi i L} E_\omega(\textbf{r}) * \exp{\bigg\{ \frac{ik}{2L}\big[ (x')^2 + (y')^2 \big]\bigg\}}\\
%   &= \exp{(ikL)}\mathcal{F}^{-1}\big\{\mathcal{F}\{E_\omega(\textbf{r})\}\mathcal{F}\{h(\textbf{r}')\}\big]\}\\
%   &=\exp{(ikL)}\mathcal{F}^{-1}\big\{\mathcal{F}\{E_\omega(\textbf{r})\}\exp\big[-i\pi\lambda L\big(f_x^2+f_y^2\big)\big]\},
% \end{split}
% \end{equation}
% where $\mathcal{F}\{\bullet\}$ is the two-dimensional Fourier transform (FT) and $\mathcal{F}^{-1}\{\bullet\}$ denotes inverse FT. This second approach is efficiently implemented in SRW using only two fast Fourier transforms (FFTs) because the kernel $h(\textbf{r}')$ has an analytical Fourier transform. Downsides to the FFT-based implementation include the heavy sampling needed to avoid aliasing and also necessary in order to resolve small features in the propagated wavefront $ E_\omega(\textbf{r}')$ , since the application of Eq.~\ref{eq:FresnelConv} limits the range and sampling in the output plane to those of the input plane $ E_\omega(\textbf{r})$ \cite{Kelly2014}.

% A second family of propagators is obtained by the analytical treatment of the quadratic radiation phase term in Eq.~\ref{eq:Fresnel}, which allows for considerable economy of memory and CPU resources as compared to
% the standard Fresnel free-space propagator \cite{ChubarCelestre}. Without losing generality, we assume that the electric field $E_\omega(\textbf{r})$ has a quadratic phase term defined by the wavefront curvature radii $(R_x, R_y)$ centred at $(x_0,y_0)$:
%  \begin{equation}\label{eq:E_analytical}
% % \begin{split}
%     E_\omega(\textbf{r}) = F_\omega(\textbf{r})\exp\bigg\{ \frac{ik}{2}\bigg[ \frac{(x-x_0)^2}{R_x} + \frac{(y-y_0)^2}{R_y} \bigg]\bigg\}.
% % \end{split}
% \end{equation}
% Plugging Eq.~\ref{eq:E_analytical} into Eq.~\ref{eq:Fresnel} and collecting terms:
% \begin{equation}\label{eq:Fresnel_analytical}
% \begin{split}
%     E_\omega(\textbf{r}') = \qquad\qquad\qquad\qquad\qquad\qquad\qquad\qquad\qquad\quad &\\
%     \frac{k\exp{(ikL)}}{2\pi i L}\exp\bigg\{ \frac{ik}{2}\bigg[ \frac{(x'-x_0)^2}{R_x+L} + \frac{(y'-y_0)^2}{R_y+L} \bigg] \bigg\}\cdot \qquad\quad &\\
%     \cdot\int\limits_{\Sigma}{F_\omega(\textbf{r})\exp{\bigg\{ \frac{ik}{2L}\bigg[ \frac{R_x+L}{R_x}\bigg(\frac{R_xx'+Lx_0}{R_x+L}-x\bigg)^2+}} \enspace\\
%     \hfill+ \frac{R_y+L}{R_y}\bigg(\frac{R_yy'+Ly_0}{R_y+L}-y\bigg)^2\bigg] & \bigg\}~\mathrm{d}\textbf{s}.
% \end{split}
% \end{equation}
% Much like Eq.~\ref{eq:Fresnel}, Eq.~\ref{eq:Fresnel_analytical} is a convolution type-integral that not only can be computed using the convolution theorem, but also has an analytical Fourier transform of its kernel. We draw attention to the fact that the convolution is done regarding scaled coordinates:
% \begin{equation}\label{eq:coordinates}
% \hat{\textbf{r}}=(\hat{x},\hat{y})=\bigg(\frac{R_xx'+Lx_0}{R_x+L}, \frac{R_yy'+Ly_0}{R_y+L}\bigg),
% \end{equation}
% Equation~\ref{eq:Fresnel_analytical} can, then, be calculated as:
% \begin{equation}\label{eq:Fresnel_analyticalConv}
% \begin{split}
% % &\frac{\exp{(ikL)}}{\sqrt{m_xm_y}}\exp{\bigg\{i\frac{k}{2L}\bigg[\bigg(\frac{m_x-1}{m_x}\bigg)x'^2 +\bigg(\frac{m_y-1}{m_y}\bigg)y'^2\bigg]\bigg\}}\cdot\\
% &E_\omega(\textbf{r}') =\exp{(ikL)}\cdot\\
% &\cdot\exp\bigg\{ \frac{ik}{2}\bigg[ \frac{(x'-x_0)^2}{R_x+L} + \frac{(y'-y_0)^2}{R_y+L} \bigg] \bigg\}\sqrt{\frac{R_xR_y}{(R_x+L)(R_y+L)}}\cdot\\
% &\cdot\mathcal{F}^{-1}\bigg\{\mathcal{F}\{F_\omega(\textbf{r})\}\exp\bigg[-i\pi\lambda L\bigg(\frac{R_x}{R_x+L}f_x^2 +\frac{R_y}{R_y+L}f_y^2\bigg)\bigg]\bigg\},
% \end{split}
% \end{equation}
% which is of particular interest because the application of the convolution theorem implemented with FFTs yields in a natural rescaling of the ranges of the output plane - see Fig.~1 in \cite{ChubarCelestre}. Padding with zeros and resampling the input field in order to obtain reasonable results in the output plane are less often necessary then when dealing with the formulation in Eq.~\ref{eq:FresnelConv}. This propagator, by far the most versatile in SRW, is presented to the user as two separate methods that differ on the estimation of the wavefront curvature $R_x$ and $R_y$ and on the processing near the beam waist ($R_x\approx-L$ and $R_y\approx-L$). 

% Two less general propagators form the third family of methods proposed by SRW. The first one is based on the Fraunhofer approximation of Eq.~\ref{eq:Fresnel} and is used for wavefront propagation over a very large distance:
%  \begin{equation}\label{eq:Frauhofer}
% \begin{split}
%     E_\omega(\textbf{r}') = &\frac{k\exp{(ikL)}}{2\pi i L}\exp{\bigg[i\frac{k}{2L}(x'^2 + y'^2)\bigg]}\cdot \\
%     &\enspace\qquad\cdot\int\limits_{\Sigma}{E_\omega(\textbf{r})\exp{\bigg[-i \frac{2\pi}{\lambda L}\big( x'x + y'y \big)\bigg]}~\mathrm{d}\textbf{s}}.
% \end{split}
% \end{equation}
% The integral in Eq.~\ref{eq:Frauhofer} is a Fourier transform of the field $E_\omega(\textbf{r})$ with spatial frequencies given by $f_x=x'\big/\lambda L$ and $f_y=y'\big/\lambda L$. Its implementation in SRW is done using a single FFT. A second propagator based on a single FFT is implemented to cover the case of a focusing wavefront being propagated over some distance to the beam waist. A converging wavefront writen as $E_\omega(\textbf{r}) = F_\omega(\textbf{r})\cdot\exp{[-i\frac{k}{2q}(x^2 + y^2)]}$ plugged into Eq.~\ref{eq:Fresnel} yields:
% \begin{equation}\label{eq:FocusingFresnel}
% \begin{split}
% E_\omega(\textbf{r}') = \qquad\qquad\qquad\qquad\qquad\qquad\qquad\qquad\qquad\qquad &\\
% \frac{k\exp{(ikL)}}{2\pi i L}\exp{\bigg[i\frac{k}{2L}(x'^2 + y'^2)\bigg]}\cdot \qquad\qquad\qquad\qquad\qquad\enspace &\\
% \cdot\int\limits_{\Sigma}{F_\omega(\textbf{r})\exp{\bigg[-i \frac{2\pi}{\lambda L}\big( x'x + y'y \big) +}} \qquad\qquad\qquad\quad&\\
% \hfill+i\frac{k}{2L}(x^2 + y^2) - i \frac{k}{2 q}\big(x^2+y^2) \bigg]~\mathrm{d}\textbf{s},&
% %&\cdot\int\limits_{\Sigma}{\check E_\omega(\textbf{r})\exp{\bigg[-i\frac{k}{2q}(x^2 + y^2) + i \frac{k}{2 L}\big(-2x'x +x^2 + -2y'y+y^2 \big)\bigg]}~\mathrm{d}\textbf{s}},
% \end{split}
% \end{equation}
% where $q$ is the distance from the input plane to the beam waist. When the wavefront is propagated to the the image plane, that is, $L=q$, the integral in Eq.~\ref{eq:FocusingFresnel} assumes the formalism of a Fourier transform with $f_x=x'\big/\lambda q$ and $f_y=y'\big/\lambda q$. 

% % -----------------------------------------------------------------
% % -----------------------------------------------------------------
% \subsubsection{The WOFRY propagators}
% % -----------------------------------------------------------------
% % -----------------------------------------------------------------
% can be used to propagate any arbitrary wavefront generated within this software and in particular, the 1D and 2D coherent modes described in \S\ref{sec:CMD}. 

% Like SRW, WOFRY offers the standard Fresnel propagator using 2 FFTs (Eq.~\ref{eq:FresnelConv}) and the Fraunhofer approximation calculated with one FFT (Eq.~\ref{eq:Frauhofer}). Both propagators are available in 1D and 2D implementations. To overcome the issues with the output plane range when applying the convolution theorem for the Fresnel propagator, WOFRY offers a implementation based on works by \citeasnoun{schmidt} and \citeasnoun{pirro2017} that permits to scale the output plane range while retaining the possibility of calculation by means of the convolution theorem. Let $m_x$ and $m_y$ be magnification factors for the output plane range and:
% \begin{equation}
% \begin{split}
%   (x'-x)^2 &= m_x\bigg(\frac{x'}{m_x}-x\bigg)^2+\bigg(\frac{m_x-1}{m_x}\bigg)x'^2+(1-m_x)x^2\\
%   (y'-y)^2 &= m_y\bigg(\frac{y'}{m_y}-y\bigg)^2+\bigg(\frac{m_y-1}{m_y}\bigg)y'^2+(1-m_y)y^2,
% \end{split}
% \end{equation}
% that we use in Eq.~\ref{eq:Fresnel}:
% \begin{equation}\label{eq:ZoomFresnel}
% \begin{split}
% &E_\omega(\textbf{r}') =\\
% &\frac{k\exp{(ikL)}}{2\pi i L}\exp{\bigg\{i\frac{k}{2L}\bigg[\bigg(\frac{m_x-1}{m_x}\bigg)x'^2 +\bigg(\frac{m_y-1}{m_y}\bigg)y'^2\bigg]\bigg\}}\\
% &\int\limits_{\Sigma}{F_\omega(\textbf{r})\exp{\bigg\{-i \frac{k}{2 L}\bigg[m_x\bigg(\frac{x'}{m_x}-x\bigg)^2+ m_y\bigg(\frac{y'}{m_y}-y\bigg)^2\bigg]\bigg\}}~\mathrm{d}\textbf{s}
% }
% \end{split}
% \end{equation}
% with:
% \begin{equation}\label{eq:E}
% E_\omega(\textbf{r}) = F_\omega(\textbf{r}) \exp{\bigg\{i \frac{k}{2 L}\big[(1-m_x)x^2+(1-m_y)y^2 \big]\bigg\}}.
% \end{equation}
% Equation~\ref{eq:ZoomFresnel} is a convolution between $F_\omega(\textbf{r})$ and a kernel with reduced scaled $\hat{\textbf{r}}=(\hat{x},\hat{y})=\big(x'\big/m_x, y'\big/m_y\big)$. This kernel has analytical Fourier transform and the application of the convolution theorem with two FFTs is possible:
% \begin{equation}\label{eq:ZoomFresnelConv}
% \begin{split}
% &E_\omega(\textbf{r}') =\\
% &\frac{\exp{(ikL)}}{\sqrt{m_xm_y}}\exp{\bigg\{i\frac{k}{2L}\bigg[\bigg(\frac{m_x-1}{m_x}\bigg)x'^2 +\bigg(\frac{m_y-1}{m_y}\bigg)y'^2\bigg]\bigg\}}\cdot\\
% &\qquad\qquad\quad\cdot\mathcal{F}^{-1}\bigg\{\mathcal{F}\{F_\omega(\textbf{r})\}\exp\bigg[-i\pi\lambda L\bigg(\frac{f_x^2}{m_x} +\frac{f_y^2}{m_y}\bigg)\bigg]\bigg\}.
% \end{split}
% \end{equation}
% Note that when $m_x=1$ and $m_y=1$ we recover Eq.~\ref{eq:Fresnel} and Eq.~\ref{eq:FresnelConv}. A 1D version of this ``zoom'' propagator is also available in WOFRY.
% %This implementation, as any implementation based on two FFTs, conserves the number of points in the array, which means that the magnification factors $m_x$ and $m_y$ are applied to the ranges of the input plane. 

% For the cases where accuracy should be privileged over execution time, a 1D paraxial version of the Rayleigh-Sommerfeld integral where $\cos(\theta)=1$ is also implemented in WOFRY. Similarly to the direct numerical calculation of the Fresnel diffraction integral, the 1D version of Eq.~\ref{eq:Huygens-Fresnel} is implemented as a Riemann summation \cite{srioLBL}. 


% -----------------------------------------------------------------
% -----------------------------------------------------------------
\subsection{Optical elements}\label{sec:OE}
% -----------------------------------------------------------------
% -----------------------------------------------------------------

Optical elements will interact with the wavefront by manipulating its amplitude and phase. A very wide range of optical elements can be represented by the complex transmission element:
 \begin{equation}\label{eq:trans_el}
T_\omega(\textbf{r})=\sqrt{\mathrm{T}_\mathrm{BL}(\textbf{r})}\exp{\big[ i\varphi(\textbf{r})\big]},
\end{equation}
which is applied to the electric field $E_\omega(\textbf{r})$ as a multiplicative factor \cite{Cloetens_1996}. This thin element approximation can be expanded to represent thick optical elements by applying the multi-slicing method, that represents an optical element as an intercalation of several thin-elements (slices) and free-space propagation between them \cite{paganin_book, Li2017, Munro2019} - see Appendix~\ref{sec:appendixTransmissionElements}. 

A generic aperture (slit, pin-holes and beam-stop) is represented by a binary opaque object: it masks part of the wavefront:

\begin{equation}
\mathrm{T}_{\text{BL}}(\textbf{r}) =
\left\{
\begin{matrix}
T,  & \mbox{~~if~~}  \textbf{r}~\text{inside}~ \textbf{A}
\\ 
1 - T, & \mbox{~~elsewhere}
\end{matrix}
\right.
\end{equation}
When the element is a slit, then $T=1$. If it is a beamstop, then $T=0$. $\textbf{A}$ is the region defined by the object boundary. 

Absorption filters, test patterns, x-ray refractive lenses, refractive correctors (free-form refractive optics), zone plates and transmission gratings are usually well represented by this thin-element approximation in projection approximation with:
\begin{subequations}
\begin{align}   
    \mathrm{T}_{\text{BL}}(\textbf{r})&=\exp{\big[-2k\beta_\omega(\textbf{r})\Delta_z(\textbf{r})\big]}\label{eq:aux_funcs_transa}  \\
    % &=\exp{\big[-\mu_\omega(\textbf{r})\Delta_z(\textbf{r})\big]},\nonumber\\
    \varphi(\textbf{r})&=-k\delta_\omega(\textbf{r})\Delta_z(\textbf{r}).\label{eq:aux_funcs_transb}
\end{align}
\end{subequations}
$\Delta_z$ is the projected thickness of an optical element along the $z-$axis. We define the index of refraction as $n_\omega=1-\delta_\omega+i\cdot\beta_\omega$. Optical errors can be simulated in a similar way \cite{Laundy2014,Celestre:mo5214,srioLBL}.

%\todo{REMOVE THIS PARAGRAPH? }
Reflective optics can also be reasonably well approximated by transmission elements with more complex calculations eg. stationary-phase methods (application of Eq.~\ref{eq:Huygens-Fresnel} over the mirror surface), geometric ray-tracing calculation of the optical path difference \cite{Canestrari2014} or even multi-slicing \cite{Li2017}. Crystal optics, however, often need a dedicated propagator for accurate representation of the manipulations to the electric field \cite{Sutter2014, Sutter2020}.

% A generic aperture is a mask that transmits a part of the wavefront complex amplitude in a range $[x_{min},x_{max}]$ and absorbs the rest. It can be
% \begin{equation}
% R(x;\omega) =
% \left\{
% \begin{matrix}
% A,  & \mbox{~~if~~} x_{min} \le x \le x_{max}
% \\ 
% 1 - A, & \mbox{~~elsewhere}
% \end{matrix}
% \right.
% \end{equation}
% When the element is a slit, then $A=1$. If it is a beamstop, then $A=0$. In the following simulations we will use an aperture of finite length $a$ centered with the beam, therefore $x_{min}=-a/2$ and $x_{max}=a/2$.

% % -----------------------------------------------------------------
% % -----------------------------------------------------------------
% \subsubsection{X-ray lenses}
% % -----------------------------------------------------------------
% % -----------------------------------------------------------------

% A refractor made by a material with refraction index $n(\omega)=1-\delta(\omega)+i\beta(\omega)$ 
% and thickness profile $z(x)$ adds a phase to the wavefront $-\lambda \delta(\omega) z(x)$ and reduce its amplitude by $\exp(-\mu z(x)/2)$, where $\mu=(4 \pi/\lambda) \delta(\omega)$ is the (intensity) attenuation coefficient. These expressions can be applied to any transmission object of profile $x(z)$ assuming valid the thin object approximation. 

% The changes induced by a real lens in the wavefront can be calculated using the thin object approximation discussed below, using the lens profile. Usually, a single lens has a parabolic interface $z=x^2/(4R)$ with $R$ the radius at the apex. A lens has two parabolic interfaces (front and back) separated by a lens thickness $d$. The interfaces are flat outside the lens aperture $L$. Therefore, the lens profile is:
% \begin{align}
%     z(x) &= \frac{1}{2R} x^2 + d; & |x| < L/2\\ \nonumber
%     z(x) &= \frac{1}{2R} (L/2)^2 + d; & |x| \ge L/2.
% \end{align}

% A Compound Refractive Lens is a pile of $N$ identical lenses. If we neglect the beam propagation in the inter-lens space, the effect of the $N$ lenses is identical of a single lens with profile $x_N(z)=N z(x)$. If one is interested in assessing the effect of the inter-lens space (e.g. for studying the adiabatic focusing \cite{Schroer_adiabatic}) the CRL must be calculated as $N$ independent lenses, applying the free-space propagator in between two consecutive lenses. For a transfocator (a transfocator is a pile of CRLs) the same concept apply: it is possible to compute the accumulated lens profile and use it as a single lens, or calculate lens by lens (or CRL by CRL) if the effect of inter-lens or inter-CRL spaces are to be taken into account.

% -----------------------------------------------------------------
% -----------------------------------------------------------------
\section{Description of the optical system}
\label{sec:beamline}
% -----------------------------------------------------------------
% -----------------------------------------------------------------

The optical system under consideration is based on the future ID18 beamline at ESRF. This will be a long beamline (200~m) for applications exploiting the beam coherence. The source considered is an undulator with period 18 mm and 138 periods (length close to 2.5 m).  
We analyze a focusing system with two transfocators, at 65 and 170 m from the source. They contain sets of 2D and 1D lenses that will permit modifying independently the focal lengths for the horizontal and vertical directions. The use of two transfocators allows a great flexibility in the beam transport \cite{Vaughan:kv5084}. The first one can be used to modify the divergence of the beam, even to collimate it, to guarantee a full illumination at the second transfocator.  

The two transfocators in use are idealized as two real beryllium lenses of variable curvature radius $R_1$ and $R_2$ that correspond to focal distances $f_1$ and $f_2$ ($f=R/2\delta$), with $\delta=$~6.96 10$^{-6}$ for Be at \SI{7}{keV}. A slit of aperture $a_h$ in horizontal and $a_v$ in vertical is placed upstream the lens-1. We set the distances matching the requirements of the EBS-ESRF ID18 beamline (see Fig.~\ref{fig:beamline}), and we analyzed the system at a photon energy of \SI{7}{keV} for different focal distances of lens-1 and lens-2. 
\onecolumn
\begin{figure}\label{fig:beamline}
    \includegraphics[width=0.99\textwidth]{figures/beamline.pdf}
    \caption{Schematic view of the beamline with the distances used in the simulations. The source is an undulator u18 set to $K$~=~1.851 (7 keV at first harmonic). CS is the ``coherence slit" that controls the coherent fraction. DCM is the double crystal monochromator (not used in the calculations). T1 and T2 are the two transfocators, idealized in single parabolic lenses. Observation plane (sample) is at 200 m from the source. 
    }
\end{figure}
\twocolumn

% \begin{table}[]
%     \label{table:id18parameters}
%     \caption{Position of the two transfocators, slit and sample (focal point) corresponding to the ID18 beamline configuration under study. }
%     \centering
%     \begin{tabular}{l|c|c}
%          element & position [m] & comment\\
%          ID (undulator) source& 0 & U18 $N_u$~=~138 $K$~=~1.851 (7 keV)\\
%          Slit & 36 &
%          variable aperture $a_h\times a_v$
%          \\
%          Transfocator 2D & 65 &
%          \\
%          Transfocator 2D & 170 & $D$~=~\SI{105}{\meter} \\
%          sample & 200 & focal plane
%     \end{tabular}
% \end{table}

We are interested in the beam properties (intensity distribution, size, flux) at the sample plane for four cases.
The first case is selected to obtain a small spot (about \SI{5}{\micro\meter}) and the second one a large spot (more than \SI{30}{\micro\meter}). For these cases the slits are selected to match a $\text{CF}_{x}=\text{CF}_{y}=90\%$ for a photon energy of \SI{7}{keV}. The values are shown in Fig.~\ref{table:2Dusercases}. The cases 3 and 4 follow the same logic but the slits are opened to increase intensity at expenses of reducing coherence  ($\text{CF}_{x}=\text{CF}_{y}=70\%$). 


\begin{table}[]
    \label{table:2Dusercases}
    \caption{Configurations selected for 2D simulations. Slit aperture ($a_h$ or $a_v$) is selected for obtaining$\text{CF}_{x}=\text{CF}_{y}=90\%$in cases 1 and 2, and $\text{CF}_{x}=\text{CF}_{y}=70\%$ in cases 3 and 4. 
    }
    \begin{tabular}{c|c|c|c|c|c}
         case h/v & $a_h/a_v$ [\SI{}{\micro\meter}] & $f_1$ [m] & $f_2$ [m] & $R_1$ [\SI{}{\micro\meter}]& $R_2$ [\SI{}{\micro\meter}] \\
         \hline
1 h &      40.3 & 46.1 &     26.5 &     641.9 &     369.5 
\\
1 v &      227.0 & 15.0 &     22.2 &     209.4 &     309.6 
\\
\hline
2 h &      40.3 & 25.1 &     21.3 &     349.1 &     296.3  
\\
2 v &      227.0 & 42.2 &     55.6 &     588.6 &     775.3 
\\
\hline \hline
3 h &      85.1 & 46.1 &     31.8 &     641.9 &     443.7 
\\
3 v &      506.7 & 85.2 &     27.8 &     1187.4 &     387.6  
\\
\hline
4 h &      85.1 & 25.1 &     20.7 &     349.1 &     288.7 
\\
4 v &      506.7 & 42.2 &     55.7 &     588.6 &     776.0 

    \end{tabular}
\end{table}


\section{Results of multi-optics simulations}
\label{sec:complete-beamline}

Calculations are done using different methodologies, implemented in four different software codes. 

\subsection{Source propagated up to the entrance slit}

We first calculated the illumination at the entrance slit plane. The beam at this position comes from the free propagation of the undulator emission, therefore it has the same coherence fraction as the source. The intensity distribution is shown in Fig.~\ref{fig:intensityat36m}, where the horizontal and vertical profiles calculated by Wofry1D and SRW-ME are compared. The effect of the partial coherence is important: a coherent beam would give very different values \todo{add numbers? repeat the simulations here}. \todo{may be comment 1) that the coherent illumination if different for SRW (zero emittance) than for Wofry1D (zeroth mode), and 2) we could calculate precisely the FWHM values of the profiles and compare with the typical analytical convolution calculation.}   

\todo{Look at the comparison... they have significant differences... Questions/Comments: 
\begin{itemize}
    \item  In Figs 2 and 3 I added the SRW profiles (extracted in OASYS with SRW ME output files) they are small differences... In Fig 3 I also added the DoC SRW (not in Fig. 2 as I do not have the .1 and .2 files). The Doc and 1st harmonoc are very different... to be discussed! 
    \item The division by the intensity for getting DoC adds a lot of noise when the intensity is small. Can we compare CSD((x1+x2)/2,(x1-x2)/2) instead? 
    \item I always have doubts if my factor ()/2 is correctly set.
\end{itemize}
}


\newpage
\onecolumn
\begin{figure}
    \label{fig:CSD_SRW_vs_I_source}
    \includegraphics[width=0.75\textwidth]{CSD_SRW_vs_I_source.pdf}
    \includegraphics[width=0.35\textwidth]{figures/CSD_WOFRY1D_vs_I_source_h.png}
    \includegraphics[width=0.35\textwidth]{figures/CSD_WOFRY1D_vs_I_source_v.png}
    \caption{Calculations @source. Top: SRW, bottom: WOFRY1D.
SRW (top): Horizontal FWHM: 73.08 [um]. 
Vertical FWHM: 18.28 [um]
Coherence length H: 6.13 [um]. 
Coherence length V: 8.53 [um].
    }
\end{figure}

\begin{figure}
    \label{fig:CSD_SRW_vs_I_36m}
    \includegraphics[width=0.75\textwidth]{CSD_SRW_vs_I_36m.pdf}
    \includegraphics[width=0.35\textwidth]{figures/CSD_WOFRY1D_vs_I_36m_h.png}
    \includegraphics[width=0.35\textwidth]{figures/CSD_WOFRY1D_vs_I_36m_v.png}
    
    \caption{Calculations @36m. Top: SRW, bottom: WOFRY1D.
    
    SRW (top): 
    Horizontal FWHM: 649.53 [um].
    Vertical FWHM: 569.21 [um].   Coherence length H: 44.74 [um].
    Coherence length V: 206.90 [um].
    }
\end{figure}

\twocolumn


\newpage
\begin{figure}
    \label{fig:CSD_SRW_source}
    \includegraphics[width=0.99\textwidth]{SRW_CSD_source.pdf}
    \caption{SRW calculations @source}
\end{figure}

\begin{figure}
    \label{fig:CSD_SRW_source}
    \includegraphics[width=0.49\textwidth]{figures/WOFRY1_CSD_source_h.png}
    \includegraphics[width=0.49\textwidth]{figures/WOFRY1_CSD2_source_h.png}
    \includegraphics[width=0.49\textwidth]{figures/WOFRY1_CSD_source_v.png}
    \includegraphics[width=0.49\textwidth]{figures/WOFRY1_CSD2_source_v.png}
    \caption{WOFRY1 calculations @source}
\end{figure}


\newpage

\begin{figure}
    \label{fig:CSD_SRW_36m}
    \includegraphics[width=0.99\textwidth]{SRW_CSD_36m.pdf}
    \caption{SRW calculations @36m}
\end{figure}

\begin{figure}
    \label{fig:CSD_SRW_source}
    \includegraphics[width=0.49\textwidth]{figures/WOFRY1_CSD_36m_h.png}
    \includegraphics[width=0.49\textwidth]{figures/WOFRY1_CSD2_36m_h.png}
    \includegraphics[width=0.49\textwidth]{figures/WOFRY1_CSD_36m_v.png}
    \includegraphics[width=0.49\textwidth]{figures/WOFRY1_CSD2_36m_v.png}
    \caption{WOFRY1 calculations @36m}
\end{figure}

\newpage

% \inred{Info on Figs~\ref{fig:CSD_SRW_source} and \ref{fig:CSD_SRW_vs_I_source}:}
% INFO: >>> intensity bis7.0keV intensity.dat
% INFO: Horizontal FWHM: 73.08 [um]
% INFO: Vertical FWHM: 18.28 [um]
% INFO: >>> CSDx7.0keV 15k ME intensity.dat
% INFO: Coherence length: 6.13 [um]
% INFO: >>> CSDy7.0keV 15k ME intensity.dat
% INFO: Coherence length: 8.53 [um]


% \inred{Info on Figs~\ref{fig:CSD_SRW_36m} and \ref{fig:CSD_SRW_vs_I_36m}:}
% INFO: >>> intensity bis7.0keV intensity.dat
% INFO: Horizontal FWHM: 649.53 [um]
% INFO: Vertical FWHM: 569.21 [um]
% INFO: >>> CSDx7.0keV 15k ME intensity.dat
% INFO: Coherence length: 44.74 [um]
% INFO: >>> CSDy7.0keV 15k ME intensity.dat
% INFO: Coherence length: 206.90 [um]

\subsection{Image at sample position}

The results of intensity distribution at the sample plane are display in Figs.~\ref{fig:sim_results}(a)-(d), for results using hybrid, SRW, COMSYL and WOFRY1D codes, respectively.  Beam dimensions are obtained by calculating the full width at half maximum (FWHM) from the intensity distribution at one direction, resulting by integrating the other direction. They are displayed in the plots, and summarized in Table~\ref{table:comparison}.
The results for case 1 shows an horizontal profile mostly triangular with shoulders that evidence small diffraction fringes. The fringes are more resolved in the vertical direction. Case 2  presents in horizontal a soft Gaussian-like profile, but in vertical important symmetric shoulders are remarked. Case 3 shows a smooth Gaussian profile in horizontal and a small shoulder with fringes in vertical. Case 4 shows a conventional smooth profile in horizontal but an original three-lobe plateau in vertical. This variety of profile distribution demonstrates how relevant the diffraction effects are, which modulate the beam shape in a non-trivial way.  

\newpage
\onecolumn

\begin{figure}
    \label{fig:sim_results}
    \includegraphics[width=0.85\textwidth]{figures/fig_sim_results.pdf}
    \caption{Calculations of the intensity distribution at the focal plane for the cases listed in Table~\ref{table:2Dusercases}.}
\end{figure}


% \begin{figure}
%     \label{fig:hybrid}
%     \includegraphics[width=0.99\textwidth]{figures/fig_hybrid.pdf}
%     \caption{Hybrid ray-tracing calculations of the intensity distribution at the focal plane for the cases listed in Table~\ref{table:2Dusercases}.}
% \end{figure}

% \begin{figure}\label{fig:srw}
%     \includegraphics[width=0.99\textwidth]{figures/fig_srw.pdf}
%     \caption{Multi-electron SRW calculations of the intensity distribution at the focal plane for the cases listed in Table~\ref{table:2Dusercases}.}
% \end{figure}


% \begin{figure}\label{fig:comsyl}
%     \includegraphics[width=0.99\textwidth]{figures/fig_comsyl.pdf}
%     \caption{COMSYL calculations of the intensity distribution at the focal plane for the cases listed in Table~\ref{table:2Dusercases}.
%     }
% \end{figure}


% \begin{figure}\label{fig:2DWofry1D}
%     \includegraphics[width=0.99\textwidth]{figures/fig_wofry.pdf}
%     \caption{2D intensity distribution at the focal plane. It has been constructed from the Wofry1D calculations.
%     }
% \end{figure}

\newpage

\twocolumn


\begin{table}[]
    \label{table:comparison}
    \caption{Comparison of sizes (FWHM, in \SI{}{\micro\meter}) calculated with different methods for the cases defined in Table~\ref{table:2Dusercases}.
    In brackets, the values for the fully coherent beam (single electron with SRW, first coherent mode with COMSYL/WOFRY), and zero emittance with Hybrid). \todo{flip columns}
    }
    \centering
    \begin{tabular}{p{0.05\textwidth}|c|c|c|c|c}
         case h/v &
         Wofry1D&
         COMSYL&
         SRW&
         Hybrid \\
         \hline
1 h  & 8.5(8.1)    & 10.0 (9.9)  & 8.6 (7.5)   & 17.3 (17.5) \\
1 v  & 4.8(4.8)    & 4.7 (5.1)   & 4.6 (4.6)   & 3.3 (3.1) \\
\hline
2 h  & 39.9(38.2)  & 39.5 (39.5) & 40.0 (36.1)  & 39.9 (37.5) \\
2 v  & 32.4(29.6)  & 30.6 (29.3) & 34.4 (29.6)  & 74.0 (75.3) \\
\hline
3 h  & 37.5(29.0)  & 36.6 (28.1) & 40.3 (28.4)  & 43.3 (33.0) \\
3 v  & 6.1 (4.9)   & 6.4 (5.7)   & 6.3 (4.6)    & 6.5 (5.8) \\
\hline
4 h  & 24.6(19.1)  & 26.1 (18.6)  & 27.4 (18.0)   & 27.1 (18.8) \\
4 v  & 133.7(110.3)& 111.7 (90.4) & 137.4 (132.0) & 150.2 (159.8) \\
    \end{tabular}
\end{table}

Hybrid ray-tracing for the four cases defined in Table~\ref{table:2Dusercases} are shown in  Fig.~\ref{fig:sim_results}(a). One can observe that the intensity distributions as not as structured as for the wave-optics methods (e.g. the three-lobe plateau in case 4v is not reproduced). Values of FWHM are in consonance with full wave-optics calculations for most cases (with the exception of two particular cases:
1h (hybrid \SI{16.5}{\micro\meter} Wofry1D \SI{8.5}{\micro\meter}),
2v (\SI{71.2}{\micro\meter} Wofry1D \SI{32.4}{\micro\meter}). They will be discussed in the next section.


SRW-ME results for the four cases are shown in Fig.~\ref{fig:sim_results}(b). The good convergence of the values displayed is guarantee by a convergence analysis described in Appendix~\ref{appendix:srw}.
It was used to determine the minimum number of electrons that produce accurate results. The SRW-ME simulations for the cases analyzed converge with only a few thousands electrons, that can be run in less than one hour in a node with 28 CPUs totalizing 256 GB. The reason is that the beam after the slit has a relatively high CF. 


COMSYL requires high performance computing (HPC) to perform full CMD of undulator beam, by
solving the Friedholm problem and obtain the full 2D eigenfunctions (coherent modes) and eigenvalues.
Simulation of the source with COMSYL took 55 min using 28 x 3.30 GHz CPUs of 251.82 GB RAM, for getting 174 modes of 1691 $\times$ 563 pixels.
The modes calculated by COMSYL are loaded in the OASYS environment \cite{codeOASYS} to propagate the modes along the beamline.
The propagation uses 2D zoom propagator and the optical elements available in WOFRY. Results are shown in Fig.~\ref{fig:sim_results}(c). 
The beam profiles calculated with COMSYL are a bit noisy, which could be improved by increasing the source sampling and further optimizing the propagation parameters. 


WOFRY 1D results are shown in Fig.~\ref{fig:sim_results}(d). The 1D intensity profile for one direction is obtained from the summation of several modes. High modes have very low eigenvalue and it is enough to consider only 10 modes for reproducing more that 99\% of the spectral density. The 2D intensity distribution shown in Fig.~\ref{fig:sim_results}(d) is obtained combining the calculated horizontal and vertical 1D profiles via the outer product. We can observe in the intensity distributions the same structures due to the diffraction effects than were observed with the other calculation methods. 
The agreement between the results of Wofry1D in Fig.~\ref{fig:sim_results}(d) with SRW - Fig.~\ref{fig:sim_results}(b) - is striking. All intensity distributions reproduce exactly the same features, and the FWHM values are different in less than 12\%, a value that is compatible with the errors of the simulations (discussed in section~\ref{sec:discussion}). This results validates the 1D CMD method proposed here, whose requirements in computer power are extremely low (it runs very fast in an averaged laptop).  

The specific numeric value for sizes calculated with the different methods (Table~\ref{table:comparison}) depends not only on the code itself, but also on the particular specific parameters in each method (number of pixels for sampling wavefronts, propagation parameters, etc.). To estimate the calculation error in the final size numbers, we vary randomly these specific parameters in a reasonable range (e.g., 10\%). The evaluation of the mean size and the dispersion (standard deviation) of the sizes obtained give an good estimation of the error in this parameter. This exercise would take a considerable computational effort using 2D methods, but it can be easily done with Wofry1D. We run 200 cases with 10\% random variation in the values in number of pixels and magnification factor in drift spaces. The obtained sizes (horizontal $\times$ vertical) are  
8.49 $\pm$ 0.60 $\times$ 4.97 $\pm$ 0.37 \SI{}{\micro\meter}$^2$ (case 1),
39.94 $\pm$ 2.98 $\times$ 32.77 $\pm$ 2.69 \SI{}{\micro\meter}$^2$ (case 2),
36.39 $\pm$ 2.89 $\times$ 6.12 $\pm$ 0.51 \SI{}{\micro\meter}$^2$ (case 3), and
24.18 $\pm$ 1.80 $\times$ 133.44 $\pm$ 10.06 \SI{}{\micro\meter}$^2$ (case 4). We confirmed that the values given in Fig.~\ref{fig:sim_results}(d) are within these error intervals.


The calculated beam sizes should be completed with flux. At \SI{7}{keV}, the undulator in the configuration selected emits a flux of 1.5 10$^{15}$ photons/s/0.1\%bw. Each of the three elements studied (slit, lens -1 and lens-2) absorb part of the flux. The estimation of the absorption by the slit can be done using simple geometrical arguments, and the absorption by the slits depend on the average Be thickness presented to the beam. The linear attenuation coefficient of Be at 7 keV is $\mu=$~\SI{3}{\centi\meter}$^{-1}$, giving 1.45\% attenuation for a \SI{50}{\micro\meter} thick layer (like lens thickness used in simulations\footnote{In the simulations the horizontal and vertical focusing are separated in two lenses, with accumulated thickness \SI{100}{\micro\meter} thus absorption 3\%}). For the case 1 simulations we extracted the absorption for the different absorbing elements (slit, lens-1 and lens-2) in the case of partial coherence and also for full coherence (see Table~\ref{table:absorption}).
There is excellent agreement for partial coherence. For full coherence, the Wofry1D results are different than the SRW+Hybrid, because the geometry of the 1st coherent mode used to represent the full coherent beam is not the same as the geometry of the filament beam (used in SRW and Hybrid). We note a high absorption in lens-2, due to the fact that in this case the lens-2 is overilluminated, therefore the \SI{1}{\milli\meter} physical aperture absorbs considerably the beam.

\begin{table}[]
    \label{table:absorption}
    \caption{Comparison of beam intensity attenuation in percent by the slit, lens-1 and lens-2 for the partial coherent beam, 
    % coherent beam (first coherent mode in Wofry1D, filament beam in SRW, zero emittance in Hybrid) and for the partial coherent beam,
    for the four cases studied.
    The Wofry1D data shown here comes after combining the horizontal and vertical wavefronts using the outer product. 
    }
    \centering
\begin{tabular}{l|lll|lll|lll}
case & \multicolumn{3}{c|}{slit} & \multicolumn{3}{c|}{lens-1} & \multicolumn{3}{c|}{lens-2} \\
\hline
     & \rot{Wofry1D} & \rot{SRW} & \rot{Hybrid}
     & \rot{Wofry1D} & \rot{SRW} & \rot{Hybrid}
     & \rot{Wofry1D} & \rot{SRW} & \rot{Hybrid}
\\
\hline
%    &          &      &        &          &      &         &          &       &         \\
%1      &   87.0   & 96.6 & 96.7   & 7.6      & 7.4  & 5.2     & 48.3     & 51.3  & 53.0   \\
1       &   97.6   & 97.6 & 97.2   & 7.9      & 7.6  & 5.2     & 50.7     & 51.1  & 52.6   \\
% 2c    &   87.0   & 96.6 & 96.7   & 6.7      & 6.4  & 4.3     & 3.8      & 3.7   & 3.3    \\
2       &   97.6   & 97.6 & 97.2   & 7.0      & 6.6  & 4.3     & 3.9      & 3.7   & 3.3    \\
% 3c    &   55.9   & 86.0 & 85.6   & 5.4      & 6.11 & 4.7     & 17.1     & 22.7  & 26.6   \\
3       &   89.5   & 90.2 & 88.6   & 6.3      & 6.1  & 4.6     & 23.4     & 21.8  & 25.2   \\
% 4c    &   55.9   & 86.0 & 85.6   & 6.8      & 7.73 & 6.4     & 3.6      & 3.6   & 3.6    \\
4       &   89.5   & 90.2 & 88.6   & 8.0      & 7.7  & 6.2     & 3.8      & 3.6  & 3.6   \\
\end{tabular}
\end{table}

% -----------------------------------------------------------------
% -----------------------------------------------------------------
\section{Discussion}
\label{sec:discussion}
% -----------------------------------------------------------------
% -----------------------------------------------------------------

% Our discussion follows a hierarchical approach, as discussed in \citeasnoun{hierarchical}, with the idea of balancing accuracy and computational effort, to subsequently select and use the most advantageous method for the analyzed problem. 
% This multi-method analysis will also help to validate the new 1D CMD method introduced in this work. The results of the Wofry1D results are compared with other well-known simulation packages. 


There is good agreement in focal size FWHM values in all methods (see Table~\ref{table:comparison}), but also in the shape of intensity distributions, in particular for the wave optics methods - compare Figs.~\ref{fig:sim_results}(b)-(d). 

Regarding computer resources, the Wofry1D code can be run in a few seconds in a laptop, whereas the simulation of the full CMD with COMSYL required about 1h (for 1691 x 563 pixels, 174 modes) using 1 node of 28 cores. This source is then reused for propagating the different configurations. Each configuration required a full SRW-ME with 5000 electrons run in also about 1h in a similar configuration. 

\todo{a possible paragraph discussing surface errors. Just to show it as a proof of concept: FEM at the white mirror, slope error at the mirros, FEM at the monochromator... Cons: it will be done with only Wofry1D (too much work for the full collection of codes); the results will not change what we have}


\todo{A possible discussion of the Gaussian Shell-model. I am not much in favor of including the GSM here, but it can be done. Main points for the discussion:

\begin{itemize}
\item Discuss how to match the GSM with undulator parameters: there are several possibilities... I prefer matching the size and CF. 
\item Compare Hermite-Gaussian modes with numerical modes. There are similar nut not identical. For incoherent sources the GSM may be a good approximation, for pretty coherent sources not. 
\item Show that propagation of GSM modes is very different than propagating undulator modes. Indeed, because $\sigma \sigma' = \lambda / (4 \pi)$ in GSM and with $2\pi$ in undulator either the size at the source or the propagated size is wrong with GSM.
\item Analytical propagation of the modes (as described by Vartanyants et al.) only works for ideal elements, and Gaussian slits. They fail in simulating structures like those that we obtain, because they are originated by the slit, which is non-Gaussian.
\end{itemize}
}


% \subsection{Hybrid ray-tracing}

% The simulation results for the four cases studied using the hybrid method indicate that, although this method does not reproduce exactly the intensity distibution given by full partial coherent optics, the numerical values are approaching the good ones, but with two exceptions: the case 
% 1h (hybrid \SI{16.5}{\micro\meter} Wofry1D \SI{8.5}{\micro\meter}) and the case 
% 2v (\SI{71.2}{\micro\meter} Wofry1D \SI{32.4}{\micro\meter}). 
% We remark that these thee cases have in common that the $f_1$ value in use is close to $f_1$~=~\SI{40}{\meter} that corresponds to the singularity in the analytical (geometrical optics) calculations, when the lens-1 focuses on lens-2. A detailed study with hybrid was performed to calculate the FWHM for all possible values of $f_1$ (as done in Fig.~\ref{fig:focalSizes}. The result (Fig.~\ref{fig:focalSizes_hybrid}) confirms that there is good agreement everywhere except in the region close to $f_1$~=~\SI{40}{\micro\meter}.
% We thus conclude that the hybrid ray-tracing is a valid method to obtain good values of focal sizes in most cases, excepts for the case that lens-1 focus is close to the position of lens-2 ($f_1 \approx $~\SI{40}{\meter}).


% \begin{figure}
%     \centering

%     \includegraphics[width=0.95\textwidth]{figures/sizes_h_hybrid.eps}
%     \includegraphics[width=0.95\textwidth]{figures/sizes_v_hybrid.eps}
        
%     \caption{Focal sizes obtained by hybrid ray-tracing method, for two slit aperture cases, compared with values from Wofry1D  (from Fig.~\ref{fig:focalSizes}).}
%     \label{fig:focalSizes_hybrid}
% \end{figure}

% \subsection{Further simulations}

The simulations presented, motivated by the ID18 project, use a simplified optical layout. A more complete study including the other optical elements, other transfocator configurations will be presented elsewhere, also for different energies and implementing the effect of surface errors due to thermal load and surface finish. 

% We have also calculated the beam evolution in the neighbourhood of the sample position for the four cases studied (see Fig.~\ref{fig:caustic}). From these plots one can obtain the position of the best focus and the depth of focus. The depth of focus (measured as the distance where the peak value is reduced by 15\%) is larger than two meters (except for the cases 1v, 3v). \todo{redo these plots and compare with SRW... otherwise supress?}

% In some cases there is a mismatch between the position of the best focus and its expected position (the sample position, at the zero abscissas). This effect, certainly due to an error in setting $f_2$, may have several origins. 

% For pairing two transfocators, the algorithm chosen to calculate the $f_2$ value consist in analyzing the wavefront at the lens-2 position, find a corrector refractive object that would transform the incoming wavefront in a converging wavefront (see section \ref{sec:refractorCorrector}), and fit the radius at the center. We then get the $R_2$ and therefore the $f_2$ value. In addition, to obtain smooth $(f_1,f_2)$ curves in Fig.~\ref{fig:f1f2map} we have used a Gaussian slit (see section \ref{sec:gaussianslit}). It smears out the diffraction fringes, because in an ideallized system where a point source is focused at the sample position, the recorded intensity would correspond to the diffraction pattern of the slit, that can be considered as an "object" placed in the beam (see e.g. \cite{paganin_book}). The use of a Gaussian object implies that its diffraction pattern is a Gaussian with no diffraction fringes. 

% For cases 1h, 1v, 3v (see  Fig.~\ref{fig:caustic}), there is a good agreement between the focal position obtained from the maximum of intensity on-axis (plotted at the top of the image) and our expected position (the zero in the plots). In some other cases (2v, 3h, 4h) the agreement is acceptable, taking into account that the observed depth of focus is of the order of meters. A small correction in $f_2$ would bring the best focus to its ideal position. This correction is necessary because we used a Gaussian slit for calculating $f_2$, thus neglecting some oscillations around the $(f_1,f_2)$ curves. There are two pathological cases where the algorithm used to calculate $f_2$ did not succeed: the cases 2h and 4v.
% The error in $f_2$  for case 2h is also due to the oscillations in the $(f_1,f_2)$ and can be corrected, as shown in Fig.~\ref{fig:causticcorrection}a. However, case 4v cannot be corrected because we would need a divergent lens to bring the focus of $f_1$ to the sample position. Setting $R_2=f_2=\infty$ would reduce the beam size at the sample position (Fig.~\ref{fig:causticcorrection}b), but cannot get the best focus there. However, an ad-hoc defined refractive corrector in the place of lens-2 would do the job (Fig.~\ref{fig:causticcorrection}d).  

 



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% \begin{figure}\label{fig:caustic}
% \centering

% \includegraphics[width=0.99\textwidth]{figures/fig_caustic.pdf}

% \caption{Evolution of the beam size in the around the sample position for the cases listed in Table~\ref{table:2Dusercases}. The top and side graphs correspond to the profiles passing by (0,0).
% }
% \end{figure}



% \begin{figure}\label{fig:causticcorrection}
% \centering
% \includegraphics[width=0.99\textwidth]{figures/fig_caustic_correction.pdf}

% \caption{Evolution of the beam size in the around the sample position for the ``pathological" case 2h and 4v shown in Fig.~\ref{fig:caustic}. Top row: using corrected lens-2 with $R_2$=\SI{410}{\micro\meter} ($f_2=$\SI{29.4}{\meter}) for case 2h and $R_2=f_2=\infty$ for case 4v. Bottom: using a free-form refractive corrector instead of lens-2.
% }
% \end{figure}


% \subsection{Errors in optical surfaces}

% % \todo{Rafael, please re-read}
% The performance of X-ray optics in the new generation synchrotron beamlines is limited by the quality of the optical surfaces \cite{lengeler1999,Yabashi}. Finish errors can be divided in three families: i) height errors, associated with surface finishing (high spatial frequency), ii) figure errors, associated with deviations from ideal profile (e.g. bending, gravity sag, thermal deformations), and iii) slope errors or waviness, associated to medium spatial frequencies \cite{srio1992, signorato1997}. Finish errors in x-ray lenses can be measured by different techniques (eg. grating interferometry, x-ray speckle tracking or ptychography) and readily included in the simulations \cite{Celestre:mo5214}. Some profiles measured at ESRF using x-ray speckle tracking \cite{berujon2020} with height error RMS of the order of \SI{1}{\micro\meter} are used to verify that the focal spot produced by lenses with realistic errors is not degraded with respect to the ideal lens surface. 

% Usually the optics of new generation synchrotron beamlines is limited by the quality of the optical surface. Typically are due to surface finish (slope errors and height errors) and shape errors, often due to heat load. 
% \todo{Rafael, would you please work next paragraph. I checked that your error file (profile 1 in DABAM2D) does not produce relevant changes, thus the idea is to "mention" the errors without presenting a full study.} Surface errors in lens surfaces can be experimentally measured by different techniques (e.g. speckle tracking, ptychography) and included in the simulations. Some profiles measured at ESRF \cite{???} with height error RMS of the order of \SI{1}{\micro\meter}  are used to verify that the focal spot produced by lenses with realistic errors is not degraded with respect to the ideal lens surface. 

% The effect of finish errors in the white double-mirror system is also analyzed using a measured mirror meridional profile of \SI{2.5}{\nano\meter} height error RMS and \SI{140}{\nano\radian} RMS slope error. 

% % \todo{Philipp, please re-read}
% The heat load affect several elements of the beamline. For the beamline under consideration, the affected elements (white beam mirrors, and double-crystal monochromators) are not presented in our simulations. Finite element analysis of mirrors and crystals done for other EBS beamlines \cite{Brumund} show that the deformation height profile can be decomposed it two parts: an average bending that is possible to correct by a small readjustment of the focal length of the optical elements downstream the heated element, and a ``residual error" which remain after removing the averaged bending radius, and could only be corrected using adaptive optics. Wofry1D simulations using FEA-generated deformations at the first crystal of a monochromator placed just after the coherent slit showed no significant degradation of the focal spot, both in size and shape. This is mainly due to the low power transmitted by the coherent slit. We checked that the focused beam is almost unchanged when using a profile from FEA analysis with curvature of about \SI{1}{\kilo\meter} and residual slope errors of \SI{30}{\nano\radian}. 



% The deformation profile calculated by FEA \todo{I USED FILE: SRC\_Si\_3.0mrad\_08000eV\_mo\_Si111\_Size1\_nodalOut.out} is is loaded in a ``mirror-like" element in Wofry, as described \cite{srioLBL}. For case 1, a small degradation in the horizontal direction is found (passing from \SI{8.09}{\micro\meter} to \SI{10.21}{\micro\meter} for the first coherent mode). It is accompanied by a loss of symmetry. A large deformation in the vertical spot is observed, but a spot close to the ideal is found when a best circle is subtracted from the profile. It is then possible to correct this added curvature. Indeed, by adjusting $f_2$ \todo{I will calculate this} it is possible to compensate the effects introduced by the crystal bending due to heat load.


% finding focus https://www.optikos.com/finding-focus/

% \subsection{Practical considerations} Simulations like those presented here could be very beneficial for beamline operation, for its optimization and quick setting.  Complicated  relationships exist between the beam parameters requested by users (beam size and coherent fraction) and the beamline configuration (undulator, slit and transfocator setting). Quick simulations as done by Wofry1D could be a helpful instrument for the beamline staff to get the desired configurations. The plots shown here (e.g., $CF$ vs slit size in Fig.~\ref{fig:cf_vs_aperture}, trajectories in Fig.~\ref{fig:f1f2map}, or final size in Fig.~\ref{fig:focalSizes} could be simulated on-line and compared with results presented as look-up tables with similar aspect. We are also considering the design of a digital twin that mimics the real transfocator systems to assist beamline setting. For that, the fast simulation using the CMD method developed in Wofry1D will be an integrated component.  

% Some practical consequences can be directly deduced from the results shown here. For example, looking at Fig.~\ref{fig:focalSizes} one can observe that the same focal size can be obtained with different configurations. To get a similar size, it is better to prefer a large $f_1$ to avoid over-illuminating the lens-2 and increase transmission of lens-1. The transfocator design is simplified if we restrict the horizontal focal distance t to be smaller than the vertical $f_h>f_v$. Here, $f_v$ can be obtained with lenses focusing in 2D and $f_h$ by adding 1D lenses focusing in the horizontal plane. 

% % https://www.optikos.com/finding-focus/
% In this work we configured the transfocator to have the resulting focal position on the sample plane, an "in-focus" setup. It could also be possible to work off-focus to vary the beam size at the sample plane. The in-focus setup will generally produce the sharpest image of very small details in the image. Moreover, it will reduce the artifacts produced by the surface finish errors. Also, a larger depth of focus is obtained at this position (see e.g. Fig.~\ref{fig:causticcorrection}).

% -----------------------------------------------------------------
% -----------------------------------------------------------------
\section{Summary and conclusions}
\label{sec:summary}
% -----------------------------------------------------------------
% -----------------------------------------------------------------


We have studied a particular case of focusing a partial coherent beam (as produced by the low emittance storage ring EBS-ESRF) by a system of two transfocators (or lenses). We have verified that four simulation codes typically used to simulate synchrotron beamlines agree in the results of beam size and flux. The hybrid ray-tracing method (ShadowOUI) fails to determine fine structures in the beam intensity profiles. The three codes using physical optics (SRW-ME, COMSYL and WOFRY1D) produce essentiually the same results. Partial coherence calculations using 2D wavefronts are expensive from the computation point of view, either because many thousands of wavefronts are propagated (in SRW-ME) or because the need of diagonalizing an extremely large 4D cross-spectral function. The newly developed coherent mode decomposition of 2D CSFs (i.e. separating 1D modes for the horizontal and vertical direction) is very rapid and can be run interactively in a laptop. Its results for the particular cases simulated here agree very well with full 2D propagation methods. 
This method is available in the Wofry add-on of the OASYS suite \cite{codeOASYS}. OASYS workspaces for the simulations performed in this paper are available\footnote{{ https://github.com/oasys-esrf-kit/paper-multioptics-resources}}.

% Four cases are calculated and compared using the other methods available in OASYS, like the full 2D coherent mode decomposition using COMSYL \cite{codeCOMSYL}, the OASYS interface for the SRW \cite{codeSRW} code, and hybrid ray-tracing \cite{codeHYBRID}.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\appendix

% -----------------------------------------------------------------
% -----------------------------------------------------------------
\section{The SRW propagators}
\label{sec:appendixSRWpropagators}
% -----------------------------------------------------------------
% -----------------------------------------------------------------

 The SRW propagators are grouped into three main methods for 2D wavefront propagation \cite{SRWgit}. The first main method lies under the ``standard Fresnel propagator'', which can be implemented as: (a) direct numerical calculation of the convolution integral in Eq.~\ref{eq:Fresnel} by means of nested Riemann summations; or (b) through the application of the convolution theorem:
 \begin{equation}\label{eq:FresnelConv}
\begin{split}
    E_\omega(\textbf{r}')&=\frac{k\exp{(ikL)}}{2\pi i L} E_\omega(\textbf{r}) * \exp{\bigg\{ \frac{ik}{2L}\big[ (x')^2 + (y')^2 \big]\bigg\}}\\
   &= \exp{(ikL)}\mathcal{F}^{-1}\big\{\mathcal{F}\{E_\omega(\textbf{r})\}\mathcal{F}\{h(\textbf{r}')\}\big]\}\\
   &=\exp{(ikL)}\mathcal{F}^{-1}\big\{\mathcal{F}\{E_\omega(\textbf{r})\}\exp\big[-i\pi\lambda L\big(f_x^2+f_y^2\big)\big]\},
\end{split}
\end{equation}
where $\mathcal{F}\{\bullet\}$ is the two-dimensional Fourier transform (FT) and $\mathcal{F}^{-1}\{\bullet\}$ denotes inverse FT. This second approach is efficiently implemented in SRW using only two fast Fourier transforms (FFTs) because the kernel $h(\textbf{r}')$ has an analytical Fourier transform. Downsides to the FFT-based implementation include the heavy sampling needed to avoid aliasing and also necessary in order to resolve small features in the propagated wavefront $ E_\omega(\textbf{r}')$, since the application of Eq.~\ref{eq:FresnelConv} limits the range and sampling in the output plane to those of the input plane $ E_\omega(\textbf{r})$ \cite{Kelly2014}. The interest in having a direct- and a reciprocal-space implementation of Eq.~\ref{eq:Fresnel} is summarised in Fig.~1 from \cite{Li2015}.

A second family of propagators is obtained by the analytical treatment of the quadratic radiation phase term in Eq.~\ref{eq:Fresnel}, which allows for considerable economy of memory and CPU resources as compared to the standard Fresnel free-space propagator \cite{ChubarCelestre}. Without losing generality, we assume that the electric field $E_\omega(\textbf{r})$ has a quadratic phase term defined by the wavefront curvature radii $(R_x, R_y)$ centred at $(x_0,y_0)$:
 \begin{equation}\label{eq:E_analytical}
% \begin{split}
    E_\omega(\textbf{r}) = F_\omega(\textbf{r})\exp\bigg\{ \frac{ik}{2}\bigg[ \frac{(x-x_0)^2}{R_x} + \frac{(y-y_0)^2}{R_y} \bigg]\bigg\}.
% \end{split}
\end{equation}
Plugging Eq.~\ref{eq:E_analytical} into Eq.~\ref{eq:Fresnel} and collecting terms:
\begin{equation}\label{eq:Fresnel_analytical}
\begin{split}
    E_\omega(\textbf{r}') = \qquad\qquad\qquad\qquad\qquad\qquad\qquad\qquad\qquad\quad &\\
    \frac{k\exp{(ikL)}}{2\pi i L}\exp\bigg\{ \frac{ik}{2}\bigg[ \frac{(x'-x_0)^2}{R_x+L} + \frac{(y'-y_0)^2}{R_y+L} \bigg] \bigg\}\cdot \qquad\quad &\\
    \cdot\int\limits_{\Sigma}{F_\omega(\textbf{r})\exp{\bigg\{ \frac{ik}{2L}\bigg[ \frac{R_x+L}{R_x}\bigg(\frac{R_xx'+Lx_0}{R_x+L}-x\bigg)^2+}} \enspace\\
    \hfill+ \frac{R_y+L}{R_y}\bigg(\frac{R_yy'+Ly_0}{R_y+L}-y\bigg)^2\bigg] & \bigg\}~\mathrm{d}\textbf{s}.
\end{split}
\end{equation}
Much like Eq.~\ref{eq:Fresnel}, Eq.~\ref{eq:Fresnel_analytical} is a convolution type-integral that not only can be computed using the convolution theorem, but also has an analytical Fourier transform of its kernel. We draw attention to the fact that the convolution is done regarding scaled coordinates:
\begin{equation}\label{eq:coordinates}
\hat{\textbf{r}}=(\hat{x},\hat{y})=\bigg(\frac{R_xx'+Lx_0}{R_x+L}, \frac{R_yy'+Ly_0}{R_y+L}\bigg),
\end{equation}
Equation~\ref{eq:Fresnel_analytical} can, then, be calculated as:
\begin{equation}\label{eq:Fresnel_analyticalConv}
\begin{split}
% &\frac{\exp{(ikL)}}{\sqrt{m_xm_y}}\exp{\bigg\{i\frac{k}{2L}\bigg[\bigg(\frac{m_x-1}{m_x}\bigg)x'^2 +\bigg(\frac{m_y-1}{m_y}\bigg)y'^2\bigg]\bigg\}}\cdot\\
&E_\omega(\textbf{r}') =\exp{(ikL)}\cdot\\
&\cdot\exp\bigg\{ \frac{ik}{2}\bigg[ \frac{(x'-x_0)^2}{R_x+L} + \frac{(y'-y_0)^2}{R_y+L} \bigg] \bigg\}\sqrt{\frac{R_xR_y}{(R_x+L)(R_y+L)}}\cdot\\
&\cdot\mathcal{F}^{-1}\bigg\{\mathcal{F}\{F_\omega(\textbf{r})\}\exp\bigg[-i\pi\lambda L\bigg(\frac{R_x}{R_x+L}f_x^2 +\frac{R_y}{R_y+L}f_y^2\bigg)\bigg]\bigg\},
\end{split}
\end{equation}
which is of particular interest because the application of the convolution theorem implemented with FFTs yields in a natural rescaling of the ranges of the output plane - see Fig.~1 in \cite{ChubarCelestre}. Padding with zeros and resampling the input field in order to obtain reasonable results in the output plane are less often necessary then when dealing with the formulation in Eq.~\ref{eq:FresnelConv}. This propagator, by far the most versatile in SRW, is presented to the user as two separate methods that differ on the estimation of the wavefront curvature $R_x$ and $R_y$ and on the processing near the beam waist ($R_x\approx-L$ and $R_y\approx-L$). 

Two less general propagators form the third family of methods proposed by SRW. The first one is based on the Fraunhofer approximation of Eq.~\ref{eq:Fresnel} and is used for wavefront propagation over a very large distance (far field):
 \begin{equation}\label{eq:Frauhofer}
\begin{split}
    E_\omega(\textbf{r}') = &\frac{k\exp{(ikL)}}{2\pi i L}\exp{\bigg[i\frac{k}{2L}(x'^2 + y'^2)\bigg]}\cdot \\
    &\enspace\qquad\cdot\int\limits_{\Sigma}{E_\omega(\textbf{r})\exp{\bigg[-i \frac{2\pi}{\lambda L}\big( x'x + y'y \big)\bigg]}~\mathrm{d}\textbf{s}}.
\end{split}
\end{equation}
The integral in Eq.~\ref{eq:Frauhofer} is a Fourier transform of the field $E_\omega(\textbf{r})$ with spatial frequencies given by $f_x=x'\big/\lambda L$ and $f_y=y'\big/\lambda L$. Its implementation in SRW is done using a single FFT. A second propagator based on a single FFT is implemented to cover the case of a focusing wavefront being propagated over some distance to the beam waist. A converging wavefront writen as $E_\omega(\textbf{r}) = F_\omega(\textbf{r})\cdot\exp{[-i\frac{k}{2q}(x^2 + y^2)]}$ plugged into Eq.~\ref{eq:Fresnel} yields:
\begin{equation}\label{eq:FocusingFresnel}
\begin{split}
E_\omega(\textbf{r}') = \qquad\qquad\qquad\qquad\qquad\qquad\qquad\qquad\qquad\qquad &\\
\frac{k\exp{(ikL)}}{2\pi i L}\exp{\bigg[i\frac{k}{2L}(x'^2 + y'^2)\bigg]}\cdot \qquad\qquad\qquad\qquad\qquad\enspace &\\
\cdot\int\limits_{\Sigma}{F_\omega(\textbf{r})\exp{\bigg[-i \frac{2\pi}{\lambda L}\big( x'x + y'y \big) +}} \qquad\qquad\qquad\quad&\\
\hfill+i\frac{k}{2L}(x^2 + y^2) - i \frac{k}{2 q}\big(x^2+y^2) \bigg]~\mathrm{d}\textbf{s},&
%&\cdot\int\limits_{\Sigma}{\check E_\omega(\textbf{r})\exp{\bigg[-i\frac{k}{2q}(x^2 + y^2) + i \frac{k}{2 L}\big(-2x'x +x^2 + -2y'y+y^2 \big)\bigg]}~\mathrm{d}\textbf{s}},
\end{split}
\end{equation}
where $q$ is the distance from the input plane to the beam waist. When the wavefront is propagated to the the image plane, that is, $L=q$, the integral in Eq.~\ref{eq:FocusingFresnel} assumes the formalism of a Fourier transform with $f_x=x'\big/\lambda q$ and $f_y=y'\big/\lambda q$. 

% -----------------------------------------------------------------
% -----------------------------------------------------------------
\section{The WOFRY propagators}
\label{sec:appendixWOFRYpropagators}
% -----------------------------------------------------------------
% -----------------------------------------------------------------

The WOFRY propagators can be used to propagate any arbitrary wavefront generated within this software and in particular, the 1D and 2D coherent modes described in \S\ref{sec:CMD}. 

Like SRW, WOFRY offers the standard Fresnel propagator using 2 FFTs (Eq.~\ref{eq:FresnelConv}) and the Fraunhofer approximation calculated with one FFT (Eq.~\ref{eq:Frauhofer}). Both propagators are available in 1D and 2D implementations. To overcome the issues with the output plane range when applying the convolution theorem for the Fresnel propagator, WOFRY offers a implementation based on works by \citeasnoun{schmidt} and \citeasnoun{pirro2017} that permits to scale the output plane range while retaining the possibility of calculation by means of the convolution theorem. Let $m_x$ and $m_y$ be magnification factors for the output plane range and:
\begin{equation}
\begin{split}
  (x'-x)^2 &= m_x\bigg(\frac{x'}{m_x}-x\bigg)^2+\bigg(\frac{m_x-1}{m_x}\bigg)x'^2+(1-m_x)x^2\\
  (y'-y)^2 &= m_y\bigg(\frac{y'}{m_y}-y\bigg)^2+\bigg(\frac{m_y-1}{m_y}\bigg)y'^2+(1-m_y)y^2,
\end{split}
\end{equation}
that we use in Eq.~\ref{eq:Fresnel}:
\begin{equation}\label{eq:ZoomFresnel}
\begin{split}
&E_\omega(\textbf{r}') =\\
&\frac{k\exp{(ikL)}}{2\pi i L}\exp{\bigg\{i\frac{k}{2L}\bigg[\bigg(\frac{m_x-1}{m_x}\bigg)x'^2 +\bigg(\frac{m_y-1}{m_y}\bigg)y'^2\bigg]\bigg\}}\\
&\int\limits_{\Sigma}{F_\omega(\textbf{r})\exp{\bigg\{-i \frac{k}{2 L}\bigg[m_x\bigg(\frac{x'}{m_x}-x\bigg)^2+ m_y\bigg(\frac{y'}{m_y}-y\bigg)^2\bigg]\bigg\}}~\mathrm{d}\textbf{s}
}
\end{split}
\end{equation}
with:
\begin{equation}\label{eq:E}
E_\omega(\textbf{r}) = F_\omega(\textbf{r}) \exp{\bigg\{i \frac{k}{2 L}\big[(1-m_x)x^2+(1-m_y)y^2 \big]\bigg\}}.
\end{equation}
Equation~\ref{eq:ZoomFresnel} is a convolution between $F_\omega(\textbf{r})$ and a kernel with reduced scaled $\hat{\textbf{r}}=(\hat{x},\hat{y})=\big(x'\big/m_x, y'\big/m_y\big)$. This kernel has analytical Fourier transform and the application of the convolution theorem with two FFTs is possible:
\begin{equation}\label{eq:ZoomFresnelConv}
\begin{split}
&E_\omega(\textbf{r}') =\\
&\frac{\exp{(ikL)}}{\sqrt{m_xm_y}}\exp{\bigg\{i\frac{k}{2L}\bigg[\bigg(\frac{m_x-1}{m_x}\bigg)x'^2 +\bigg(\frac{m_y-1}{m_y}\bigg)y'^2\bigg]\bigg\}}\cdot\\
&\qquad\qquad\quad\cdot\mathcal{F}^{-1}\bigg\{\mathcal{F}\{F_\omega(\textbf{r})\}\exp\bigg[-i\pi\lambda L\bigg(\frac{f_x^2}{m_x} +\frac{f_y^2}{m_y}\bigg)\bigg]\bigg\}.
\end{split}
\end{equation}
Note that when $m_x=1$ and $m_y=1$ we recover Eq.~\ref{eq:Fresnel} and Eq.~\ref{eq:FresnelConv}. A 1D version of this ``zoom'' propagator is also available in WOFRY.
%This implementation, as any implementation based on two FFTs, conserves the number of points in the array, which means that the magnification factors $m_x$ and $m_y$ are applied to the ranges of the input plane. 

For the cases where accuracy should be privileged over execution time, a 1D paraxial version of the Rayleigh-Sommerfeld integral where $\cos(\theta)=1$ is also implemented in WOFRY. Similarly to the direct numerical calculation of the Fresnel diffraction integral, the 1D version of Eq.~\ref{eq:Huygens-Fresnel} is implemented as a Riemann summation \cite{srioLBL}. 


% -----------------------------------------------------------------
% -----------------------------------------------------------------
\section{Transmission Elements}
\label{sec:appendixTransmissionElements}
% -----------------------------------------------------------------
% -----------------------------------------------------------------

Consider an arbitrary-shaped scattering volume as shown in Fig.~\ref{fig:projection}(a). Suppose that such scatterer is completely confined within a region $z_0\leq z\leq z_1$ and outside that there is vacuum. Let this sample be illuminated by a plane-wave moving along the positive direction of the optical axis ($z-$axis). In the absence of the scatterer, the gradient between the $z=z_0$ and $z=z_1$ planes is very well defined and parallel to the optical axis, as shown in Fig.~\ref{fig:projection}(b-$\mathrm{i}$). It follows [ยง2.2 in  \cite{paganin_book}] that if the scatterer is sufficiently weak as to minimally disturb the path that the wave-field would have taken in its absence, cf. Fig.~\ref{fig:projection}(b-$\mathrm{ii}$), the transmission of a wave-field through this sample is given by:
\begin{equation}\label{eq:transmission_n}
    E_\omega(x,y,z_1)\approx\exp\Bigg\{-\frac{ik}{2}\int\limits_{z=z_0}^{z=z_1}{\big[1-n_\omega^2(x,y,z)\big]~\mathrm{d}z}\Bigg\}E_\omega(x,y,z_0).
\end{equation}{}
Eq.~\ref{eq:transmission_n} shows that the effect of a weak scatterer can be accounted by a multiplicative complex transmission element represented by the complex exponential. In the X-ray regime the index of refraction is typically very close to unity and often expressed as $n_\omega=1-\delta_\omega+i\cdot\beta_\omega$, which allows for the approximation $1-n_\omega(x,y,z)^2\approx2\big[\delta_\omega(x,y,z)-i\cdot\beta_\omega(x,y,z)\big]$ that can be substituted in Eq.~\ref{eq:transmission_n}. The $z-$dependence of $\delta_\omega$ and $\beta_\omega$ is abandoned in the projection approximation, hence the complex transmission element in Eq.~\ref{eq:transmission_n} can be reduced to:
\begin{align}\label{eq:transmission}
\mathrm{T}(x,y,z) &=\exp\Bigg\{-ik\int\limits_{z=z_0}^{z=z_1}{\big[\delta_\omega(x,y)+i\cdot\beta_\omega(x,y)\big]~\mathrm{d}z}\Bigg\}\nonumber\\
         &=\exp\Bigg\{-ik\big[\delta_\omega(x,y)+i\cdot\beta_\omega(x,y)\big]\Delta_z(x,y)\Bigg\}.
\end{align}{}
$\Delta_z$ is the projected thickness along the $z-$axis and it depends on the transverse coordinates $(x,y)$, which can be dropped out for a more concise representation. It is clear the similarity between Eq.~\ref{eq:trans_el} and \ref{eq:transmission}.

For the cases where the projection approximation may not be adequate to correctly represent the scattering volume in question, multi-slicing techniques\footnote{This technique was first described in the context of the scattering of electrons by atoms and crystals \cite{Cowley1957}.} (MS) can be used for describing the wave-field propagation inside an arbitrary-shaped scattering volume - cf. discussion in \S2.7 in \cite{paganin_book}, \cite{Li2017} and \cite{Munro2019}. Consider the scatterer depicted in Fig.~\ref{fig:projection}(a). If its presence considerably disturbs the path that the wave-field would have taken in its absence, cf. Fig.~\ref{fig:projection}(b-$\mathrm{iii}$), it is possible to section the sample into a number $N$ of parallel slabs until the projection approximation is valid between two adjacent slices - Fig.~\ref{fig:projection}(b-$\mathrm{iv}$). The projected thickness $\Delta_z$ to be used in Eq.~\ref{eq:transmission} is the one in  between slices, which are $\Delta_S=(z_1 - z_0)\big/N$ apart from each other. Each slice represented as a thin element in projection approximation is separated by vacuum. The propagation of a wave-field propagation through this sample is done step-wise, where each step is composed of a multiplication by a complex transmission element in projection approximation and a free-space propagation over a distance $\Delta_S$. The output field from this operation is again multiplied by complex transmission element in projection approximation followed by a free-space propagation from the plane $\psi_j$ to the  $\psi_{j+1}$ - refer to Fig.~\ref{fig:projection}(b-$\mathrm{iv}$). This operation is done recursively $N$ times until the wave-field emerges from the sample.

\onecolumn
\begin{figure}[]
    \centering
    {\includegraphics[width=0.69\linewidth]{figures/projection_approx.pdf}}
    \caption{(a) arbitrary-shaped scattering volume in free-space. (b) transmission element representation of said scatterer. The 3D model was taken from the \textit{3D shapes} library in the Paint 3D software from the Microsoft Corporation.}
    \label{fig:projection}
\end{figure}
\twocolumn



% -----------------------------------------------------------------
% -----------------------------------------------------------------

\section{Some considerations on partially-coherent calculations using SRW's macro-electrons \& simulation convergence}
\label{appendix:srw}
% -----------------------------------------------------------------
% -----------------------------------------------------------------

The convergence of the SRW-ME method is based on the \textit{finesse} with which the distribution $f(\mathcal{S})$ in equation~(\ref{eq:SR}) is sampled. While an exquisitely large number of \textit{me's} will lead to a more accurate simulation, the resulting calculation would be very long and impossible to be performed on personal computers within reasonable time even if performed in parallel. The number of \textit{me's} depends on overall beamline degree of coherence at the observation plane, which is impacted by the source coherent fraction and beamline overall transmission (eg. slits, creation of secondary sources or any other spatial filtering scheme). Special attention to the number of macro-electrons should be given if the simulation accounts for vibrations in the beamline elements or broad-band radiation (eg. pink beam or radiation filtered by multi-layer monochromators).

To illustrate the effect of the number of macro-electrons on the beam profile we choose the previously studied cases 1 and 3 from section~\ref{sec:complete-beamline} - due to their CF, cases 2 and 4 are expected to have the same convergence as 1 and 3, respectively. Both systems 1 \& 3 (and 2 \& 4) have the same X-ray source and are illuminated up until the slits (36~m downstream U18) by the same beam, differing mainly by the coherent fraction selected for the rest of the beamline with case 1 having a higher CF than case 3 - refer to Table~\ref{table:2Dusercases} for the complete simulation parameters. The results for a selected number of \textit{me's} are shown in Figs.~\ref{fig:me_c1} and \ref{fig:me_c3}. The 1 \textit{me} simulation represents the filament-beam source, where the electron beam emittance is negligible and the fully spatial coherence is assumed - this is often called a ``single electron simulation". On the other extreme, an exaggerated value of 100k $me's$ is chosen as a way of guaranteeing convergence by brutal-force. Two criteria are used to evaluate the convergence of the simulations: the beam shape and peak intensity stabilisation. The profile cuts in  Fig.~\ref{fig:me_c1}(a)-(b) and Fig.~\ref{fig:me_c3}(a)-(b) show that the profile shape starts to converge to that of a 100k $me's$ after $\sim$500 macroelectrons for case 1 and $\sim$1k macroelectrons for case 3. Beyond that, it is necessary to resort to the relative error standard deviation and the peak intensity stabilisation. Fig.~\ref{fig:me_c1}(c)-(d) and Fig.~\ref{fig:me_c3}(c)-(d) show that for both cases, the convergence happens between 2k and 5k $me's$. Further increase in the number of macro electrons does not translate in improvements in the simulations (see simulations for 10k $me's$ onward), but increase greatly the cost of the calculation as shown in Fig.~\ref{fig:me_t}. For the work presented here a good compromise between accuracy and efficiency of the calculations is reached at 5k $me's$. Other factors contributing to the total elapsed simulation time and overall parallel performance of SRW-ME method are presented in \S3.3 from \cite{codeSRW_MEscan}, but these do not impact the SRW-ME convergence.

It is important to note that this large scan procedure is merely illustrative. Usually an experienced optical designer starts with a good guess of the necessary number of $me's$ based on the characteristics of the source (degree of coherence) and optical system (transmission and expected degree of coherence at the observation plane). This choice usually includes considerations of time and resources consumption. If there are signs that the choice may be too low, further attempts with higher $me's$ should be done. If the simulation looks fine from the first guess, reducing the number of $me's$ is also interesting as very often it is necessary to repeat the simulations (eg. testing different configurations, different energies, tolerancing or even different observation planes). At the time of writing, the authors are unaware of any widespread metric within the SRW's community capable of giving the exact number of \textit{me's} necessary for the convergence of the SRW-ME method other than the $me's$ scan. We welcome the discussion on SRW-ME convergence and we encourage the reader to reach out if they employ any interesting and reproducible convergence metric that is less time (and resource) consuming.

% \begin{table}[]
% \label{table:me_t}
% \caption{Time}
% \resizebox{\textwidth}{!}{
% \begin{tabular}{cccccccc}
%  & 500 & 1k & 2k & 5k & 10k & 25k & 100k \\ \hline
% case 1: & 5min & 9min & 15min & 39min & 1h20min & 3h21min & 13h15min \\
% case 3: & 9min & 17min & 30min & 1h15min & 2h35min & 6h30min & 35h39min
% \end{tabular}}
% \end{table}

\begin{figure}
    \centering
    \includegraphics[width=\textwidth]{figures/c1.pdf}
    \caption{Partially-coherent simulations convergence study: case 1. (a) horizontal and (b) vertical intensity cuts at E=7~keV for $me's$ ranging from 1 to 100k. (c) errors relative to the $me's=$100k plots and (d) peak intensity.}
    \label{fig:me_c1}
\end{figure}

\begin{figure}
    \centering
    \includegraphics[width=\textwidth]{figures/c3.pdf}
    \caption{Partially-coherent simulations convergence study: case 3. (a) horizontal and (b) vertical intensity cuts at E=7~keV for $me's$ ranging from 1 to 100k. (c) errors relative to the $me's=$100k plots and (d) peak intensity.}
    \label{fig:me_c3}
\end{figure}

\begin{figure}
    \centering
    \includegraphics[width=0.8\textwidth]{figures/srw_time.pdf}
    \caption{Total elapsed time for partially-coherent simulations using a computer cluster with 28 processors for parallel calculations as a function of number of $me's$.}
    \label{fig:me_t}
\end{figure}

% \newpage
% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

 %-------------------------------------------------------------------------
 % The back matter of the paper - acknowledgements and references
 %-------------------------------------------------------------------------

 % Acknowledgements come after the appendices
\ack{\textbf{Acknowledgements}}

R.C. thanks G. Geloni (EU X-FEL) for the discussion on statistical optics applied to UR in low-emittance storage rings; O. Chubar (NSLS-II/BNL) for the clarifications on selected wavefront propagators; and S. Lordano for sharing information on beamline design for the Sirius light source.

\ack{\textbf{Funding information}}

This project has received funding from the European Unionโs Horizon 2020 Research and Innovation programme under grant agreements N$^{\circ}$ 823852 (Photon and Neutron Open Science Cloud -- PaNOSC) and N$^{\circ}$ 101007417 (NFFA-Europe Pilot Joint Activities -- NEP).

\referencelist{iucr}

%-------------------------------------------------------------------------
% TABLES AND FIGURES SHOULD BE INSERTED AFTER THE MAIN BODY OF THE TEXT
%-------------------------------------------------------------------------

\end{document}                    % DO NOT DELETE THIS LINE
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

